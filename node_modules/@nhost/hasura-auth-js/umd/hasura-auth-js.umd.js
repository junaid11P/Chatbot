(function(T,ce){typeof exports=="object"&&typeof module!="undefined"?ce(exports):typeof define=="function"&&define.amd?define(["exports"],ce):(T=typeof globalThis!="undefined"?globalThis:T||self,ce(T["@nhost/hasura-auth-js"]={}))})(this,function(T){"use strict";const ce="nhostRefreshToken",ke="nhostRefreshTokenId",he="nhostRefreshTokenExpiresAt";class ve extends Error{constructor(e){super(e.message),Error.captureStackTrace&&Error.captureStackTrace(this,this.constructor),e instanceof Error?(this.name=e.name,this.error={error:e.name,status:1,message:e.message}):(this.name=e.error,this.error=e)}}const se={status:10,error:"invalid-email",message:"Email is incorrectly formatted"},Gt={status:10,error:"invalid-mfa-type",message:"MFA type is invalid"},Bt={status:10,error:"invalid-mfa-code",message:"MFA code is invalid"},He={status:10,error:"invalid-password",message:"Password is incorrectly formatted"},dt={status:10,error:"invalid-phone-number",message:"Phone number is incorrectly formatted"},Ft={status:10,error:"invalid-mfa-ticket",message:"MFA ticket is invalid"},Ht={status:10,error:"no-mfa-ticket",message:"No MFA ticket has been provided"},$t={status:10,error:"no-refresh-token",message:"No refresh token has been provided"},Wt={status:20,error:"refresher-already-running",message:"The token refresher is already running. You must wait until is has finished before submitting a new token."},Z={status:20,error:"already-signed-in",message:"User is already signed in"},Yt={status:20,error:"unauthenticated-user",message:"User is not authenticated"},an={status:20,error:"user-not-anonymous",message:"User is not anonymous"},qt={status:20,error:"unverified-user",message:"Email needs verification"},zt={status:10,error:"invalid-refresh-token",message:"Invalid or expired refresh token"},Xt={status:1,error:"invalid-sign-in-method",message:"Invalid sign-in method"};class Pe extends Error{}Pe.prototype.name="InvalidTokenError";function cn(t){return decodeURIComponent(atob(t).replace(/(.)/g,(e,r)=>{let n=r.charCodeAt(0).toString(16).toUpperCase();return n.length<2&&(n="0"+n),"%"+n}))}function un(t){let e=t.replace(/-/g,"+").replace(/_/g,"/");switch(e.length%4){case 0:break;case 2:e+="==";break;case 3:e+="=";break;default:throw new Error("base64 string is not of the correct length")}try{return cn(e)}catch{return atob(e)}}function ln(t,e){if(typeof t!="string")throw new Pe("Invalid token specified: must be a string");e||(e={});const r=e.header===!0?0:1,n=t.split(".")[r];if(typeof n!="string")throw new Pe(`Invalid token specified: missing part #${r+1}`);let i;try{i=un(n)}catch(s){throw new Pe(`Invalid token specified: invalid base64 for part #${r+1} (${s.message})`)}try{return JSON.parse(i)}catch(s){throw new Pe(`Invalid token specified: invalid json for part #${r+1} (${s.message})`)}}/*! *****************************************************************************
  Copyright (c) Microsoft Corporation.

  Permission to use, copy, modify, and/or distribute this software for any
  purpose with or without fee is hereby granted.

  THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
  REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
  AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
  INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
  LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
  OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
  PERFORMANCE OF THIS SOFTWARE.
  ***************************************************************************** */var w=function(){return w=Object.assign||function(e){for(var r,n=1,i=arguments.length;n<i;n++){r=arguments[n];for(var s in r)Object.prototype.hasOwnProperty.call(r,s)&&(e[s]=r[s])}return e},w.apply(this,arguments)};function ht(t,e){var r={};for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&e.indexOf(n)<0&&(r[n]=t[n]);if(t!=null&&typeof Object.getOwnPropertySymbols=="function")for(var i=0,n=Object.getOwnPropertySymbols(t);i<n.length;i++)e.indexOf(n[i])<0&&Object.prototype.propertyIsEnumerable.call(t,n[i])&&(r[n[i]]=t[n[i]]);return r}function I(t){var e=typeof Symbol=="function"&&Symbol.iterator,r=e&&t[e],n=0;if(r)return r.call(t);if(t&&typeof t.length=="number")return{next:function(){return t&&n>=t.length&&(t=void 0),{value:t&&t[n++],done:!t}}};throw new TypeError(e?"Object is not iterable.":"Symbol.iterator is not defined.")}function N(t,e){var r=typeof Symbol=="function"&&t[Symbol.iterator];if(!r)return t;var n=r.call(t),i,s=[],o;try{for(;(e===void 0||e-- >0)&&!(i=n.next()).done;)s.push(i.value)}catch(l){o={error:l}}finally{try{i&&!i.done&&(r=n.return)&&r.call(n)}finally{if(o)throw o.error}}return s}function G(t,e,r){if(arguments.length===2)for(var n=0,i=e.length,s;n<i;n++)(s||!(n in e))&&(s||(s=Array.prototype.slice.call(e,0,n)),s[n]=e[n]);return t.concat(s||Array.prototype.slice.call(e))}var L;(function(t){t.Start="xstate.start",t.Stop="xstate.stop",t.Raise="xstate.raise",t.Send="xstate.send",t.Cancel="xstate.cancel",t.NullEvent="",t.Assign="xstate.assign",t.After="xstate.after",t.DoneState="done.state",t.DoneInvoke="done.invoke",t.Log="xstate.log",t.Init="xstate.init",t.Invoke="xstate.invoke",t.ErrorExecution="error.execution",t.ErrorCommunication="error.communication",t.ErrorPlatform="error.platform",t.ErrorCustom="xstate.error",t.Update="xstate.update",t.Pure="xstate.pure",t.Choose="xstate.choose"})(L||(L={}));var ge;(function(t){t.Parent="#_parent",t.Internal="#_internal"})(ge||(ge={}));var vt=L.Start,pt=L.Stop,Ne=L.Raise,$e=L.Send,Qt=L.Cancel,fn=L.NullEvent,yt=L.Assign;L.After,L.DoneState;var Jt=L.Log,dn=L.Init,mt=L.Invoke;L.ErrorExecution;var Zt=L.ErrorPlatform,hn=L.ErrorCustom,er=L.Update,vn=L.Choose,pn=L.Pure,tr=".",rr={},gt="xstate.guard",yn="",W=process.env.NODE_ENV==="production",We;function Et(t,e,r){r===void 0&&(r=tr);var n=xe(t,r),i=xe(e,r);return x(i)?x(n)?i===n:!1:x(n)?n in i:Object.keys(n).every(function(s){return s in i?Et(n[s],i[s]):!1})}function nr(t){try{return x(t)||typeof t=="number"?"".concat(t):t.type}catch{throw new Error("Events must be strings or objects with a string event.type property.")}}function Tt(t,e){try{return Ee(t)?t:t.toString().split(e)}catch{throw new Error("'".concat(t,"' is not a valid state path."))}}function mn(t){return typeof t=="object"&&"value"in t&&"context"in t&&"event"in t&&"_event"in t}function xe(t,e){if(mn(t))return t.value;if(Ee(t))return Ye(t);if(typeof t!="string")return t;var r=Tt(t,e);return Ye(r)}function Ye(t){if(t.length===1)return t[0];for(var e={},r=e,n=0;n<t.length-1;n++)n===t.length-2?r[t[n]]=t[n+1]:(r[t[n]]={},r=r[t[n]]);return e}function De(t,e){for(var r={},n=Object.keys(t),i=0;i<n.length;i++){var s=n[i];r[s]=e(t[s],s,t,i)}return r}function ir(t,e,r){var n,i,s={};try{for(var o=I(Object.keys(t)),l=o.next();!l.done;l=o.next()){var u=l.value,f=t[u];r(f)&&(s[u]=e(f,u,t))}}catch(h){n={error:h}}finally{try{l&&!l.done&&(i=o.return)&&i.call(o)}finally{if(n)throw n.error}}return s}var gn=function(t){return function(e){var r,n,i=e;try{for(var s=I(t),o=s.next();!o.done;o=s.next()){var l=o.value;i=i[l]}}catch(u){r={error:u}}finally{try{o&&!o.done&&(n=s.return)&&n.call(s)}finally{if(r)throw r.error}}return i}};function En(t,e){return function(r){var n,i,s=r;try{for(var o=I(t),l=o.next();!l.done;l=o.next()){var u=l.value;s=s[e][u]}}catch(f){n={error:f}}finally{try{l&&!l.done&&(i=o.return)&&i.call(o)}finally{if(n)throw n.error}}return s}}function qe(t){if(!t)return[[]];if(x(t))return[[t]];var e=H(Object.keys(t).map(function(r){var n=t[r];return typeof n!="string"&&(!n||!Object.keys(n).length)?[[r]]:qe(t[r]).map(function(i){return[r].concat(i)})}));return e}function H(t){var e;return(e=[]).concat.apply(e,G([],N(t),!1))}function sr(t){return Ee(t)?t:[t]}function oe(t){return t===void 0?[]:sr(t)}function ze(t,e,r){var n,i;if(D(t))return t(e,r.data);var s={};try{for(var o=I(Object.keys(t)),l=o.next();!l.done;l=o.next()){var u=l.value,f=t[u];D(f)?s[u]=f(e,r.data):s[u]=f}}catch(h){n={error:h}}finally{try{l&&!l.done&&(i=o.return)&&i.call(o)}finally{if(n)throw n.error}}return s}function Tn(t){return/^(done|error)\./.test(t)}function or(t){return!!(t instanceof Promise||t!==null&&(D(t)||typeof t=="object")&&D(t.then))}function wn(t){return t!==null&&typeof t=="object"&&"transition"in t&&typeof t.transition=="function"}function Sn(t,e){var r,n,i=N([[],[]],2),s=i[0],o=i[1];try{for(var l=I(t),u=l.next();!u.done;u=l.next()){var f=u.value;e(f)?s.push(f):o.push(f)}}catch(h){r={error:h}}finally{try{u&&!u.done&&(n=l.return)&&n.call(l)}finally{if(r)throw r.error}}return[s,o]}function ar(t,e){return De(t.states,function(r,n){if(r){var i=(x(e)?void 0:e[n])||(r?r.current:void 0);if(i)return{current:i,states:ar(r,i)}}})}function Rn(t,e){return{current:e,states:ar(t,e)}}function cr(t,e,r,n){W||X(!!t,"Attempting to update undefined context");var i=t&&r.reduce(function(s,o){var l,u,f=o.assignment,h={state:n,action:o,_event:e},y={};if(D(f))y=f(s,e.data,h);else try{for(var a=I(Object.keys(f)),c=a.next();!c.done;c=a.next()){var d=c.value,p=f[d];y[d]=D(p)?p(s,e.data,h):p}}catch(E){l={error:E}}finally{try{c&&!c.done&&(u=a.return)&&u.call(a)}finally{if(l)throw l.error}}return Object.assign({},s,y)},t);return i}var X=function(){};W||(X=function(t,e){var r=t instanceof Error?t:void 0;if(!(!r&&t)&&console!==void 0){var n=["Warning: ".concat(e)];r&&n.push(r),console.warn.apply(console,n)}});function Ee(t){return Array.isArray(t)}function D(t){return typeof t=="function"}function x(t){return typeof t=="string"}function ur(t,e){if(t)return x(t)?{type:gt,name:t,predicate:e?e[t]:void 0}:D(t)?{type:gt,name:t.name,predicate:t}:t}function An(t){try{return"subscribe"in t&&D(t.subscribe)}catch{return!1}}var fe=function(){return typeof Symbol=="function"&&Symbol.observable||"@@observable"}();We={},We[fe]=function(){return this},We[Symbol.observable]=function(){return this};function pe(t){return!!t&&"__xstatenode"in t}function _n(t){return!!t&&typeof t.send=="function"}function Xe(t,e){return x(t)||typeof t=="number"?w({type:t},e):t}function Q(t,e){if(!x(t)&&"$$type"in t&&t.$$type==="scxml")return t;var r=Xe(t);return w({name:r.type,data:r,$$type:"scxml",type:"external"},e)}function Te(t,e){var r=sr(e).map(function(n){return typeof n=="undefined"||typeof n=="string"||pe(n)?{target:n,event:t}:w(w({},n),{event:t})});return r}function bn(t){if(!(t===void 0||t===yn))return oe(t)}function On(t,e,r){if(!W){var n=t.stack?" Stacktrace was '".concat(t.stack,"'"):"";if(t===e)console.error("Missing onError handler for invocation '".concat(r,"', error was '").concat(t,"'.").concat(n));else{var i=e.stack?" Stacktrace was '".concat(e.stack,"'"):"";console.error("Missing onError handler and/or unhandled exception/promise rejection for invocation '".concat(r,"'. ")+"Original error: '".concat(t,"'. ").concat(n," Current error is '").concat(e,"'.").concat(i))}}}function lr(t,e,r,n,i){var s=t.options.guards,o={state:i,cond:e,_event:n};if(e.type===gt)return((s==null?void 0:s[e.name])||e.predicate)(r,n.data,o);var l=s==null?void 0:s[e.type];if(!l)throw new Error("Guard '".concat(e.type,"' is not implemented on machine '").concat(t.id,"'."));return l(r,n.data,o)}function fr(t){return typeof t=="string"?{type:t}:t}function Qe(t,e,r){var n=function(){},i=typeof t=="object",s=i?t:null;return{next:((i?t.next:t)||n).bind(s),error:((i?t.error:e)||n).bind(s),complete:((i?t.complete:r)||n).bind(s)}}function Je(t,e){return"".concat(t,":invocation[").concat(e,"]")}function wt(t){return(t.type===Ne||t.type===$e&&t.to===ge.Internal)&&typeof t.delay!="number"}var we=Q({type:dn});function St(t,e){return e&&e[t]||void 0}function Ce(t,e){var r;if(x(t)||typeof t=="number"){var n=St(t,e);D(n)?r={type:t,exec:n}:n?r=n:r={type:t,exec:void 0}}else if(D(t))r={type:t.name||t.toString(),exec:t};else{var n=St(t.type,e);if(D(n))r=w(w({},t),{exec:n});else if(n){var i=n.type||t.type;r=w(w(w({},n),t),{type:i})}else r=t}return r}var de=function(t,e){if(!t)return[];var r=Ee(t)?t:[t];return r.map(function(n){return Ce(n,e)})};function Rt(t){var e=Ce(t);return w(w({id:x(t)?t:e.id},e),{type:e.type})}function In(t,e){return{type:Ne,event:typeof t=="function"?t:Xe(t),delay:e?e.delay:void 0,id:e==null?void 0:e.id}}function kn(t,e,r,n){var i={_event:r},s=Q(D(t.event)?t.event(e,r.data,i):t.event),o;if(x(t.delay)){var l=n&&n[t.delay];o=D(l)?l(e,r.data,i):l}else o=D(t.delay)?t.delay(e,r.data,i):t.delay;return w(w({},t),{type:Ne,_event:s,delay:o})}function dr(t,e){return{to:e?e.to:void 0,type:$e,event:D(t)?t:Xe(t),delay:e?e.delay:void 0,id:e&&e.id!==void 0?e.id:D(t)?t.name:nr(t)}}function Pn(t,e,r,n){var i={_event:r},s=Q(D(t.event)?t.event(e,r.data,i):t.event),o;if(x(t.delay)){var l=n&&n[t.delay];o=D(l)?l(e,r.data,i):l}else o=D(t.delay)?t.delay(e,r.data,i):t.delay;var u=D(t.to)?t.to(e,r.data,i):t.to;return w(w({},t),{to:u,_event:s,event:s.data,delay:o})}var Nn=function(t,e,r){return w(w({},t),{value:x(t.expr)?t.expr:t.expr(e,r.data,{_event:r})})},xn=function(t){return{type:Qt,sendId:t}};function Dn(t){var e=Rt(t);return{type:L.Start,activity:e,exec:void 0}}function Cn(t){var e=D(t)?t:Rt(t);return{type:L.Stop,activity:e,exec:void 0}}function Un(t,e,r){var n=D(t.activity)?t.activity(e,r.data):t.activity,i=typeof n=="string"?{id:n}:n,s={type:L.Stop,activity:i};return s}var Mn=function(t){return{type:yt,assignment:t}};function Ln(t,e){var r=e?"#".concat(e):"";return"".concat(L.After,"(").concat(t,")").concat(r)}function Ze(t,e){var r="".concat(L.DoneState,".").concat(t),n={type:r,data:e};return n.toString=function(){return r},n}function et(t,e){var r="".concat(L.DoneInvoke,".").concat(t),n={type:r,data:e};return n.toString=function(){return r},n}function Ue(t,e){var r="".concat(L.ErrorPlatform,".").concat(t),n={type:r,data:e};return n.toString=function(){return r},n}var jn=function(t){var e,r,n=[];try{for(var i=I(t),s=i.next();!s.done;s=i.next())for(var o=s.value,l=0;l<o.actions.length;){if(o.actions[l].type===yt){n.push(o.actions[l]),o.actions.splice(l,1);continue}l++}}catch(u){e={error:u}}finally{try{s&&!s.done&&(r=i.return)&&r.call(i)}finally{if(e)throw e.error}}return n};function tt(t,e,r,n,i,s,o){o===void 0&&(o=!1);var l=o?[]:jn(i),u=l.length?cr(r,n,l,e):r,f=o?[r]:void 0,h=[];function y(d,p){var E;switch(p.type){case Ne:{var m=kn(p,u,n,t.options.delays);return s&&typeof m.delay=="number"&&s(m,u,n),m}case $e:var S=Pn(p,u,n,t.options.delays);if(!W){var R=p.delay;X(!x(R)||typeof S.delay=="number","No delay reference for delay expression '".concat(R,"' was found on machine '").concat(t.id,"'"))}return s&&S.to!==ge.Internal&&(d==="entry"?h.push(S):s(S,u,n)),S;case Jt:{var b=Nn(p,u,n);return s==null||s(b,u,n),b}case vn:{var j=p,C=(E=j.conds.find(function(v){var g=ur(v.cond,t.options.guards);return!g||lr(t,g,u,n,s?void 0:e)}))===null||E===void 0?void 0:E.actions;if(!C)return[];var k=N(tt(t,e,u,n,[{type:d,actions:de(oe(C),t.options.actions)}],s,o),2),M=k[0],O=k[1];return u=O,f==null||f.push(u),M}case pn:{var C=p.get(u,n.data);if(!C)return[];var $=N(tt(t,e,u,n,[{type:d,actions:de(oe(C),t.options.actions)}],s,o),2),_=$[0],K=$[1];return u=K,f==null||f.push(u),_}case pt:{var b=Un(p,u,n);return s==null||s(b,r,n),b}case yt:{u=cr(u,n,[p],s?void 0:e),f==null||f.push(u);break}default:var Y=Ce(p,t.options.actions),F=Y.exec;if(s)s(Y,u,n);else if(F&&f){var ye=f.length-1,me=w(w({},Y),{exec:function(v){for(var g=[],A=1;A<arguments.length;A++)g[A-1]=arguments[A];F.apply(void 0,G([f[ye]],N(g),!1))}});Y=me}return Y}}function a(d){var p,E,m=[];try{for(var S=I(d.actions),R=S.next();!R.done;R=S.next()){var b=R.value,j=y(d.type,b);j&&(m=m.concat(j))}}catch(C){p={error:C}}finally{try{R&&!R.done&&(E=S.return)&&E.call(S)}finally{if(p)throw p.error}}return h.forEach(function(C){s(C,u,n)}),h.length=0,m}var c=H(i.map(a));return[c,u]}var Se=function(t,e){var r=e(t);return r};function hr(t){var e;return e={id:t,send:function(){},subscribe:function(){return{unsubscribe:function(){}}},getSnapshot:function(){},toJSON:function(){return{id:t}}},e[fe]=function(){return this},e}function Kn(t,e,r,n){var i,s=fr(t.src),o=(i=e==null?void 0:e.options.services)===null||i===void 0?void 0:i[s.type],l=t.data?ze(t.data,r,n):void 0,u=o?vr(o,t.id,l):hr(t.id);return u.meta=t,u}function vr(t,e,r){var n=hr(e);if(n.deferred=!0,pe(t)){var i=n.state=Se(void 0,function(){return(r?t.withContext(r):t).initialState});n.getSnapshot=function(){return i}}return n}function Vn(t){try{return typeof t.send=="function"}catch{return!1}}function Gn(t){return Vn(t)&&"id"in t}function Bn(t){var e;return w((e={subscribe:function(){return{unsubscribe:function(){}}},id:"anonymous",getSnapshot:function(){}},e[fe]=function(){return this},e),t)}var rt=function(t){return t.type==="atomic"||t.type==="final"};function pr(t){return Object.keys(t.states).map(function(e){return t.states[e]})}function Me(t){return pr(t).filter(function(e){return e.type!=="history"})}function yr(t){var e=[t];return rt(t)?e:e.concat(H(Me(t).map(yr)))}function Le(t,e){var r,n,i,s,o,l,u,f,h=new Set(t),y=At(h),a=new Set(e);try{for(var c=I(a),d=c.next();!d.done;d=c.next())for(var p=d.value,E=p.parent;E&&!a.has(E);)a.add(E),E=E.parent}catch(O){r={error:O}}finally{try{d&&!d.done&&(n=c.return)&&n.call(c)}finally{if(r)throw r.error}}var m=At(a);try{for(var S=I(a),R=S.next();!R.done;R=S.next()){var p=R.value;if(p.type==="compound"&&(!m.get(p)||!m.get(p).length))y.get(p)?y.get(p).forEach(function($){return a.add($)}):p.initialStateNodes.forEach(function($){return a.add($)});else if(p.type==="parallel")try{for(var b=(o=void 0,I(Me(p))),j=b.next();!j.done;j=b.next()){var C=j.value;a.has(C)||(a.add(C),y.get(C)?y.get(C).forEach(function($){return a.add($)}):C.initialStateNodes.forEach(function($){return a.add($)}))}}catch($){o={error:$}}finally{try{j&&!j.done&&(l=b.return)&&l.call(b)}finally{if(o)throw o.error}}}}catch(O){i={error:O}}finally{try{R&&!R.done&&(s=S.return)&&s.call(S)}finally{if(i)throw i.error}}try{for(var k=I(a),M=k.next();!M.done;M=k.next())for(var p=M.value,E=p.parent;E&&!a.has(E);)a.add(E),E=E.parent}catch(O){u={error:O}}finally{try{M&&!M.done&&(f=k.return)&&f.call(k)}finally{if(u)throw u.error}}return a}function mr(t,e){var r=e.get(t);if(!r)return{};if(t.type==="compound"){var n=r[0];if(n){if(rt(n))return n.key}else return{}}var i={};return r.forEach(function(s){i[s.key]=mr(s,e)}),i}function At(t){var e,r,n=new Map;try{for(var i=I(t),s=i.next();!s.done;s=i.next()){var o=s.value;n.has(o)||n.set(o,[]),o.parent&&(n.has(o.parent)||n.set(o.parent,[]),n.get(o.parent).push(o))}}catch(l){e={error:l}}finally{try{s&&!s.done&&(r=i.return)&&r.call(i)}finally{if(e)throw e.error}}return n}function Fn(t,e){var r=Le([t],e);return mr(t,At(r))}function je(t,e){return Array.isArray(t)?t.some(function(r){return r===e}):t instanceof Set?t.has(e):!1}function Hn(t){return G([],N(new Set(H(G([],N(t.map(function(e){return e.ownEvents})),!1)))),!1)}function nt(t,e){return e.type==="compound"?Me(e).some(function(r){return r.type==="final"&&je(t,r)}):e.type==="parallel"?Me(e).every(function(r){return nt(t,r)}):!1}function $n(t){return t===void 0&&(t=[]),t.reduce(function(e,r){return r.meta!==void 0&&(e[r.id]=r.meta),e},{})}function gr(t){return new Set(H(t.map(function(e){return e.tags})))}function Er(t,e){if(t===e)return!0;if(t===void 0||e===void 0)return!1;if(x(t)||x(e))return t===e;var r=Object.keys(t),n=Object.keys(e);return r.length===n.length&&r.every(function(i){return Er(t[i],e[i])})}function Wn(t){return typeof t!="object"||t===null?!1:"value"in t&&"_event"in t}function Yn(t,e){var r=t.exec,n=w(w({},t),{exec:r!==void 0?function(){return r(e.context,e.event,{action:t,state:e,_event:e._event})}:void 0});return n}var ue=function(){function t(e){var r=this,n;this.actions=[],this.activities=rr,this.meta={},this.events=[],this.value=e.value,this.context=e.context,this._event=e._event,this._sessionid=e._sessionid,this.event=this._event.data,this.historyValue=e.historyValue,this.history=e.history,this.actions=e.actions||[],this.activities=e.activities||rr,this.meta=$n(e.configuration),this.events=e.events||[],this.matches=this.matches.bind(this),this.toStrings=this.toStrings.bind(this),this.configuration=e.configuration,this.transitions=e.transitions,this.children=e.children,this.done=!!e.done,this.tags=(n=Array.isArray(e.tags)?new Set(e.tags):e.tags)!==null&&n!==void 0?n:new Set,this.machine=e.machine,Object.defineProperty(this,"nextEvents",{get:function(){return Hn(r.configuration)}})}return t.from=function(e,r){if(e instanceof t)return e.context!==r?new t({value:e.value,context:r,_event:e._event,_sessionid:null,historyValue:e.historyValue,history:e.history,actions:[],activities:e.activities,meta:{},events:[],configuration:[],transitions:[],children:{}}):e;var n=we;return new t({value:e,context:r,_event:n,_sessionid:null,historyValue:void 0,history:void 0,actions:[],activities:void 0,meta:void 0,events:[],configuration:[],transitions:[],children:{}})},t.create=function(e){return new t(e)},t.inert=function(e,r){if(e instanceof t){if(!e.actions.length)return e;var n=we;return new t({value:e.value,context:r,_event:n,_sessionid:null,historyValue:e.historyValue,history:e.history,activities:e.activities,configuration:e.configuration,transitions:[],children:{}})}return t.from(e,r)},t.prototype.toStrings=function(e,r){var n=this;if(e===void 0&&(e=this.value),r===void 0&&(r="."),x(e))return[e];var i=Object.keys(e);return i.concat.apply(i,G([],N(i.map(function(s){return n.toStrings(e[s],r).map(function(o){return s+r+o})})),!1))},t.prototype.toJSON=function(){var e=this;e.configuration,e.transitions;var r=e.tags;e.machine;var n=ht(e,["configuration","transitions","tags","machine"]);return w(w({},n),{tags:Array.from(r)})},t.prototype.matches=function(e){return Et(e,this.value)},t.prototype.hasTag=function(e){return this.tags.has(e)},t.prototype.can=function(e){var r;W&&X(!!this.machine,"state.can(...) used outside of a machine-created State object; this will always return false.");var n=(r=this.machine)===null||r===void 0?void 0:r.getTransitionData(this,e);return!!(n!=null&&n.transitions.length)&&n.transitions.some(function(i){return i.target!==void 0||i.actions.length})},t}(),qn={deferEvents:!1},Tr=function(){function t(e){this.processingEvent=!1,this.queue=[],this.initialized=!1,this.options=w(w({},qn),e)}return t.prototype.initialize=function(e){if(this.initialized=!0,e){if(!this.options.deferEvents){this.schedule(e);return}this.process(e)}this.flushEvents()},t.prototype.schedule=function(e){if(!this.initialized||this.processingEvent){this.queue.push(e);return}if(this.queue.length!==0)throw new Error("Event queue should be empty when it is not processing events");this.process(e),this.flushEvents()},t.prototype.clear=function(){this.queue=[]},t.prototype.flushEvents=function(){for(var e=this.queue.shift();e;)this.process(e),e=this.queue.shift()},t.prototype.process=function(e){this.processingEvent=!0;try{e()}catch(r){throw this.clear(),r}finally{this.processingEvent=!1}},t}(),_t=new Map,zn=0,Ke={bookId:function(){return"x:".concat(zn++)},register:function(t,e){return _t.set(t,e),t},get:function(t){return _t.get(t)},free:function(t){_t.delete(t)}};function bt(){if(typeof globalThis!="undefined")return globalThis;if(typeof self!="undefined")return self;if(typeof window!="undefined")return window;if(typeof global!="undefined")return global;W||console.warn("XState could not find a global object in this environment. Please let the maintainers know and raise an issue here: https://github.com/statelyai/xstate/issues")}function Xn(){var t=bt();if(t&&"__xstate__"in t)return t.__xstate__}function Qn(t){if(bt()){var e=Xn();e&&e.register(t)}}function Jn(t,e){e===void 0&&(e={});var r=t.initialState,n=new Set,i=[],s=!1,o=function(){if(!s){for(s=!0;i.length>0;){var f=i.shift();r=t.transition(r,f,u),n.forEach(function(h){return h.next(r)})}s=!1}},l=Bn({id:e.id,send:function(f){i.push(f),o()},getSnapshot:function(){return r},subscribe:function(f,h,y){var a=Qe(f,h,y);return n.add(a),a.next(r),{unsubscribe:function(){n.delete(a)}}}}),u={parent:e.parent,self:l,id:e.id||"anonymous",observers:n};return r=t.start?t.start(u):r,l}var Zn={sync:!1,autoForward:!1},q;(function(t){t[t.NotStarted=0]="NotStarted",t[t.Running=1]="Running",t[t.Stopped=2]="Stopped"})(q||(q={}));var ei=function(){function t(e,r){r===void 0&&(r=t.defaultOptions);var n=this;this.machine=e,this.delayedEventsMap={},this.listeners=new Set,this.contextListeners=new Set,this.stopListeners=new Set,this.doneListeners=new Set,this.eventListeners=new Set,this.sendListeners=new Set,this.initialized=!1,this.status=q.NotStarted,this.children=new Map,this.forwardTo=new Set,this._outgoingQueue=[],this.init=this.start,this.send=function(h,y){if(Ee(h))return n.batch(h),n.state;var a=Q(Xe(h,y));if(n.status===q.Stopped)return W||X(!1,'Event "'.concat(a.name,'" was sent to stopped service "').concat(n.machine.id,`". This service has already reached its final state, and will not transition.
Event: `).concat(JSON.stringify(a.data))),n.state;if(n.status!==q.Running&&!n.options.deferEvents)throw new Error('Event "'.concat(a.name,'" was sent to uninitialized service "').concat(n.machine.id,`". Make sure .start() is called for this service, or set { deferEvents: true } in the service options.
Event: `).concat(JSON.stringify(a.data)));return n.scheduler.schedule(function(){n.forward(a);var c=n._nextState(a);n.update(c,a)}),n._state},this.sendTo=function(h,y,a){var c=n.parent&&(y===ge.Parent||n.parent.id===y),d=c?n.parent:x(y)?y===ge.Internal?n:n.children.get(y)||Ke.get(y):_n(y)?y:void 0;if(!d){if(!c)throw new Error("Unable to send event to child '".concat(y,"' from service '").concat(n.id,"'."));W||X(!1,"Service '".concat(n.id,"' has no parent: unable to send event ").concat(h.type));return}if("machine"in d){if(n.status!==q.Stopped||n.parent!==d||n.state.done){var p=w(w({},h),{name:h.name===hn?"".concat(Ue(n.id)):h.name,origin:n.sessionId});!a&&n.machine.config.predictableActionArguments?n._outgoingQueue.push([d,p]):d.send(p)}}else!a&&n.machine.config.predictableActionArguments?n._outgoingQueue.push([d,h.data]):d.send(h.data)},this._exec=function(h,y,a,c){c===void 0&&(c=n.machine.options.actions);var d=h.exec||St(h.type,c),p=D(d)?d:d?d.exec:h.exec;if(p)try{return p(y,a.data,n.machine.config.predictableActionArguments?{action:h,_event:a}:{action:h,state:n.state,_event:a})}catch(F){throw n.parent&&n.parent.send({type:"xstate.error",data:F}),F}switch(h.type){case Ne:{var E=h;n.defer(E);break}case $e:var m=h;if(typeof m.delay=="number"){n.defer(m);return}else m.to?n.sendTo(m._event,m.to,a===we):n.send(m._event);break;case Qt:n.cancel(h.sendId);break;case vt:{if(n.status!==q.Running)return;var S=h.activity;if(!n.machine.config.predictableActionArguments&&!n.state.activities[S.id||S.type])break;if(S.type===L.Invoke){var R=fr(S.src),b=n.machine.options.services?n.machine.options.services[R.type]:void 0,j=S.id,C=S.data;W||X(!("forward"in S),"`forward` property is deprecated (found in invocation of '".concat(S.src,"' in in machine '").concat(n.machine.id,"'). ")+"Please use `autoForward` instead.");var k="autoForward"in S?S.autoForward:!!S.forward;if(!b){W||X(!1,"No service found for invocation '".concat(S.src,"' in machine '").concat(n.machine.id,"'."));return}var M=C?ze(C,y,a):void 0;if(typeof b=="string")return;var O=D(b)?b(y,a.data,{data:M,src:R,meta:S.meta}):b;if(!O)return;var $=void 0;pe(O)&&(O=M?O.withContext(M):O,$={autoForward:k}),n.spawn(O,j,$)}else n.spawnActivity(S);break}case pt:{n.stopChild(h.activity.id);break}case Jt:var _=h,K=_.label,Y=_.value;K?n.logger(K,Y):n.logger(Y);break;default:W||X(!1,"No implementation found for action type '".concat(h.type,"'"));break}};var i=w(w({},t.defaultOptions),r),s=i.clock,o=i.logger,l=i.parent,u=i.id,f=u!==void 0?u:e.id;this.id=f,this.logger=o,this.clock=s,this.parent=l,this.options=i,this.scheduler=new Tr({deferEvents:this.options.deferEvents}),this.sessionId=Ke.bookId()}return Object.defineProperty(t.prototype,"initialState",{get:function(){var e=this;return this._initialState?this._initialState:Se(this,function(){return e._initialState=e.machine.initialState,e._initialState})},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"state",{get:function(){return W||X(this.status!==q.NotStarted,"Attempted to read state from uninitialized service '".concat(this.id,"'. Make sure the service is started first.")),this._state},enumerable:!1,configurable:!0}),t.prototype.execute=function(e,r){var n,i;try{for(var s=I(e.actions),o=s.next();!o.done;o=s.next()){var l=o.value;this.exec(l,e,r)}}catch(u){n={error:u}}finally{try{o&&!o.done&&(i=s.return)&&i.call(s)}finally{if(n)throw n.error}}},t.prototype.update=function(e,r){var n,i,s,o,l,u,f,h,y=this;if(e._sessionid=this.sessionId,this._state=e,(!this.machine.config.predictableActionArguments||r===we)&&this.options.execute)this.execute(this.state);else for(var a=void 0;a=this._outgoingQueue.shift();)a[0].send(a[1]);if(this.children.forEach(function(O){y.state.children[O.id]=O}),this.devTools&&this.devTools.send(r.data,e),e.event)try{for(var c=I(this.eventListeners),d=c.next();!d.done;d=c.next()){var p=d.value;p(e.event)}}catch(O){n={error:O}}finally{try{d&&!d.done&&(i=c.return)&&i.call(c)}finally{if(n)throw n.error}}try{for(var E=I(this.listeners),m=E.next();!m.done;m=E.next()){var p=m.value;p(e,e.event)}}catch(O){s={error:O}}finally{try{m&&!m.done&&(o=E.return)&&o.call(E)}finally{if(s)throw s.error}}try{for(var S=I(this.contextListeners),R=S.next();!R.done;R=S.next()){var b=R.value;b(this.state.context,this.state.history?this.state.history.context:void 0)}}catch(O){l={error:O}}finally{try{R&&!R.done&&(u=S.return)&&u.call(S)}finally{if(l)throw l.error}}if(this.state.done){var j=e.configuration.find(function(O){return O.type==="final"&&O.parent===y.machine}),C=j&&j.doneData?ze(j.doneData,e.context,r):void 0;this._doneEvent=et(this.id,C);try{for(var k=I(this.doneListeners),M=k.next();!M.done;M=k.next()){var p=M.value;p(this._doneEvent)}}catch(O){f={error:O}}finally{try{M&&!M.done&&(h=k.return)&&h.call(k)}finally{if(f)throw f.error}}this._stop(),this._stopChildren(),Ke.free(this.sessionId)}},t.prototype.onTransition=function(e){return this.listeners.add(e),this.status===q.Running&&e(this.state,this.state.event),this},t.prototype.subscribe=function(e,r,n){var i=this,s=Qe(e,r,n);this.listeners.add(s.next),this.status!==q.NotStarted&&s.next(this.state);var o=function(){i.doneListeners.delete(o),i.stopListeners.delete(o),s.complete()};return this.status===q.Stopped?s.complete():(this.onDone(o),this.onStop(o)),{unsubscribe:function(){i.listeners.delete(s.next),i.doneListeners.delete(o),i.stopListeners.delete(o)}}},t.prototype.onEvent=function(e){return this.eventListeners.add(e),this},t.prototype.onSend=function(e){return this.sendListeners.add(e),this},t.prototype.onChange=function(e){return this.contextListeners.add(e),this},t.prototype.onStop=function(e){return this.stopListeners.add(e),this},t.prototype.onDone=function(e){return this.status===q.Stopped&&this._doneEvent?e(this._doneEvent):this.doneListeners.add(e),this},t.prototype.off=function(e){return this.listeners.delete(e),this.eventListeners.delete(e),this.sendListeners.delete(e),this.stopListeners.delete(e),this.doneListeners.delete(e),this.contextListeners.delete(e),this},t.prototype.start=function(e){var r=this;if(this.status===q.Running)return this;this.machine._init(),Ke.register(this.sessionId,this),this.initialized=!0,this.status=q.Running;var n=e===void 0?this.initialState:Se(this,function(){return Wn(e)?r.machine.resolveState(e):r.machine.resolveState(ue.from(e,r.machine.context))});return this.options.devTools&&this.attachDev(),this.scheduler.initialize(function(){r.update(n,we)}),this},t.prototype._stopChildren=function(){this.children.forEach(function(e){D(e.stop)&&e.stop()}),this.children.clear()},t.prototype._stop=function(){var e,r,n,i,s,o,l,u,f,h;try{for(var y=I(this.listeners),a=y.next();!a.done;a=y.next()){var c=a.value;this.listeners.delete(c)}}catch(k){e={error:k}}finally{try{a&&!a.done&&(r=y.return)&&r.call(y)}finally{if(e)throw e.error}}try{for(var d=I(this.stopListeners),p=d.next();!p.done;p=d.next()){var c=p.value;c(),this.stopListeners.delete(c)}}catch(k){n={error:k}}finally{try{p&&!p.done&&(i=d.return)&&i.call(d)}finally{if(n)throw n.error}}try{for(var E=I(this.contextListeners),m=E.next();!m.done;m=E.next()){var c=m.value;this.contextListeners.delete(c)}}catch(k){s={error:k}}finally{try{m&&!m.done&&(o=E.return)&&o.call(E)}finally{if(s)throw s.error}}try{for(var S=I(this.doneListeners),R=S.next();!R.done;R=S.next()){var c=R.value;this.doneListeners.delete(c)}}catch(k){l={error:k}}finally{try{R&&!R.done&&(u=S.return)&&u.call(S)}finally{if(l)throw l.error}}if(!this.initialized)return this;this.initialized=!1,this.status=q.Stopped,this._initialState=void 0;try{for(var b=I(Object.keys(this.delayedEventsMap)),j=b.next();!j.done;j=b.next()){var C=j.value;this.clock.clearTimeout(this.delayedEventsMap[C])}}catch(k){f={error:k}}finally{try{j&&!j.done&&(h=b.return)&&h.call(b)}finally{if(f)throw f.error}}this.scheduler.clear(),this.scheduler=new Tr({deferEvents:this.options.deferEvents})},t.prototype.stop=function(){var e=this,r=this.scheduler;return this._stop(),r.schedule(function(){var n;if(!(!((n=e._state)===null||n===void 0)&&n.done)){var i=Q({type:"xstate.stop"}),s=Se(e,function(){var o=H(G([],N(e.state.configuration),!1).sort(function(y,a){return a.order-y.order}).map(function(y){return de(y.onExit,e.machine.options.actions)})),l=N(tt(e.machine,e.state,e.state.context,i,[{type:"exit",actions:o}],e.machine.config.predictableActionArguments?e._exec:void 0,e.machine.config.predictableActionArguments||e.machine.config.preserveActionOrder),2),u=l[0],f=l[1],h=new ue({value:e.state.value,context:f,_event:i,_sessionid:e.sessionId,historyValue:void 0,history:e.state,actions:u.filter(function(y){return!wt(y)}),activities:{},events:[],configuration:[],transitions:[],children:{},done:e.state.done,tags:e.state.tags,machine:e.machine});return h.changed=!0,h});e.update(s,i),e._stopChildren(),Ke.free(e.sessionId)}}),this},t.prototype.batch=function(e){var r=this;if(this.status===q.NotStarted&&this.options.deferEvents)W||X(!1,"".concat(e.length,' event(s) were sent to uninitialized service "').concat(this.machine.id,`" and are deferred. Make sure .start() is called for this service.
Event: `).concat(JSON.stringify(event)));else if(this.status!==q.Running)throw new Error("".concat(e.length,' event(s) were sent to uninitialized service "').concat(this.machine.id,'". Make sure .start() is called for this service, or set { deferEvents: true } in the service options.'));if(e.length){var n=!!this.machine.config.predictableActionArguments&&this._exec;this.scheduler.schedule(function(){var i,s,o=r.state,l=!1,u=[],f=function(c){var d=Q(c);r.forward(d),o=Se(r,function(){return r.machine.transition(o,d,void 0,n||void 0)}),u.push.apply(u,G([],N(r.machine.config.predictableActionArguments?o.actions:o.actions.map(function(p){return Yn(p,o)})),!1)),l=l||!!o.changed};try{for(var h=I(e),y=h.next();!y.done;y=h.next()){var a=y.value;f(a)}}catch(c){i={error:c}}finally{try{y&&!y.done&&(s=h.return)&&s.call(h)}finally{if(i)throw i.error}}o.changed=l,o.actions=u,r.update(o,Q(e[e.length-1]))})}},t.prototype.sender=function(e){return this.send.bind(this,e)},t.prototype._nextState=function(e,r){var n=this;r===void 0&&(r=!!this.machine.config.predictableActionArguments&&this._exec);var i=Q(e);if(i.name.indexOf(Zt)===0&&!this.state.nextEvents.some(function(o){return o.indexOf(Zt)===0}))throw i.data.data;var s=Se(this,function(){return n.machine.transition(n.state,i,void 0,r||void 0)});return s},t.prototype.nextState=function(e){return this._nextState(e,!1)},t.prototype.forward=function(e){var r,n;try{for(var i=I(this.forwardTo),s=i.next();!s.done;s=i.next()){var o=s.value,l=this.children.get(o);if(!l)throw new Error("Unable to forward event '".concat(e,"' from interpreter '").concat(this.id,"' to nonexistant child '").concat(o,"'."));l.send(e)}}catch(u){r={error:u}}finally{try{s&&!s.done&&(n=i.return)&&n.call(i)}finally{if(r)throw r.error}}},t.prototype.defer=function(e){var r=this,n=this.clock.setTimeout(function(){"to"in e&&e.to?r.sendTo(e._event,e.to,!0):r.send(e._event)},e.delay);e.id&&(this.delayedEventsMap[e.id]=n)},t.prototype.cancel=function(e){this.clock.clearTimeout(this.delayedEventsMap[e]),delete this.delayedEventsMap[e]},t.prototype.exec=function(e,r,n){n===void 0&&(n=this.machine.options.actions),this._exec(e,r.context,r._event,n)},t.prototype.removeChild=function(e){var r;this.children.delete(e),this.forwardTo.delete(e),(r=this.state)===null||r===void 0||delete r.children[e]},t.prototype.stopChild=function(e){var r=this.children.get(e);r&&(this.removeChild(e),D(r.stop)&&r.stop())},t.prototype.spawn=function(e,r,n){if(this.status!==q.Running)return vr(e,r);if(or(e))return this.spawnPromise(Promise.resolve(e),r);if(D(e))return this.spawnCallback(e,r);if(Gn(e))return this.spawnActor(e,r);if(An(e))return this.spawnObservable(e,r);if(pe(e))return this.spawnMachine(e,w(w({},n),{id:r}));if(wn(e))return this.spawnBehavior(e,r);throw new Error('Unable to spawn entity "'.concat(r,'" of type "').concat(typeof e,'".'))},t.prototype.spawnMachine=function(e,r){var n=this;r===void 0&&(r={});var i=new t(e,w(w({},this.options),{parent:this,id:r.id||e.id})),s=w(w({},Zn),r);s.sync&&i.onTransition(function(l){n.send(er,{state:l,id:i.id})});var o=i;return this.children.set(i.id,o),s.autoForward&&this.forwardTo.add(i.id),i.onDone(function(l){n.removeChild(i.id),n.send(Q(l,{origin:i.id}))}).start(),o},t.prototype.spawnBehavior=function(e,r){var n=Jn(e,{id:r,parent:this});return this.children.set(r,n),n},t.prototype.spawnPromise=function(e,r){var n,i=this,s=!1,o;e.then(function(u){s||(o=u,i.removeChild(r),i.send(Q(et(r,u),{origin:r})))},function(u){if(!s){i.removeChild(r);var f=Ue(r,u);try{i.send(Q(f,{origin:r}))}catch(h){On(u,h,r),i.devTools&&i.devTools.send(f,i.state),i.machine.strict&&i.stop()}}});var l=(n={id:r,send:function(){},subscribe:function(u,f,h){var y=Qe(u,f,h),a=!1;return e.then(function(c){a||(y.next(c),!a&&y.complete())},function(c){a||y.error(c)}),{unsubscribe:function(){return a=!0}}},stop:function(){s=!0},toJSON:function(){return{id:r}},getSnapshot:function(){return o}},n[fe]=function(){return this},n);return this.children.set(r,l),l},t.prototype.spawnCallback=function(e,r){var n,i=this,s=!1,o=new Set,l=new Set,u,f=function(a){u=a,l.forEach(function(c){return c(a)}),!s&&i.send(Q(a,{origin:r}))},h;try{h=e(f,function(a){o.add(a)})}catch(a){this.send(Ue(r,a))}if(or(h))return this.spawnPromise(h,r);var y=(n={id:r,send:function(a){return o.forEach(function(c){return c(a)})},subscribe:function(a){var c=Qe(a);return l.add(c.next),{unsubscribe:function(){l.delete(c.next)}}},stop:function(){s=!0,D(h)&&h()},toJSON:function(){return{id:r}},getSnapshot:function(){return u}},n[fe]=function(){return this},n);return this.children.set(r,y),y},t.prototype.spawnObservable=function(e,r){var n,i=this,s,o=e.subscribe(function(u){s=u,i.send(Q(u,{origin:r}))},function(u){i.removeChild(r),i.send(Q(Ue(r,u),{origin:r}))},function(){i.removeChild(r),i.send(Q(et(r),{origin:r}))}),l=(n={id:r,send:function(){},subscribe:function(u,f,h){return e.subscribe(u,f,h)},stop:function(){return o.unsubscribe()},getSnapshot:function(){return s},toJSON:function(){return{id:r}}},n[fe]=function(){return this},n);return this.children.set(r,l),l},t.prototype.spawnActor=function(e,r){return this.children.set(r,e),e},t.prototype.spawnActivity=function(e){var r=this.machine.options&&this.machine.options.activities?this.machine.options.activities[e.type]:void 0;if(!r){W||X(!1,"No implementation found for activity '".concat(e.type,"'"));return}var n=r(this.state.context,e);this.spawnEffect(e.id,n)},t.prototype.spawnEffect=function(e,r){var n;this.children.set(e,(n={id:e,send:function(){},subscribe:function(){return{unsubscribe:function(){}}},stop:r||void 0,getSnapshot:function(){},toJSON:function(){return{id:e}}},n[fe]=function(){return this},n))},t.prototype.attachDev=function(){var e=bt();if(this.options.devTools&&e){if(e.__REDUX_DEVTOOLS_EXTENSION__){var r=typeof this.options.devTools=="object"?this.options.devTools:void 0;this.devTools=e.__REDUX_DEVTOOLS_EXTENSION__.connect(w(w({name:this.id,autoPause:!0,stateSanitizer:function(n){return{value:n.value,context:n.context,actions:n.actions}}},r),{features:w({jump:!1,skip:!1},r?r.features:void 0)}),this.machine),this.devTools.init(this.state)}Qn(this)}},t.prototype.toJSON=function(){return{id:this.id}},t.prototype[fe]=function(){return this},t.prototype.getSnapshot=function(){return this.status===q.NotStarted?this.initialState:this._state},t.defaultOptions={execute:!0,deferEvents:!0,clock:{setTimeout:function(e,r){return setTimeout(e,r)},clearTimeout:function(e){return clearTimeout(e)}},logger:console.log.bind(console),devTools:!1},t.interpret=Re,t}();function Re(t,e){var r=new ei(t,e);return r}function ti(t){if(typeof t=="string"){var e={type:t};return e.toString=function(){return t},e}return t}function it(t){return w(w({type:mt},t),{toJSON:function(){t.onDone,t.onError;var e=ht(t,["onDone","onError"]);return w(w({},e),{type:mt,src:ti(t.src)})}})}var Ae="",Ot="#",Ve="*",_e={},be=function(t){return t[0]===Ot},ri=function(){return{actions:{},guards:{},services:{},activities:{},delays:{}}},ni=function(t,e,r){var n=r.slice(0,-1).some(function(s){return!("cond"in s)&&!("in"in s)&&(x(s.target)||pe(s.target))}),i=e===Ae?"the transient event":"event '".concat(e,"'");X(!n,"One or more transitions for ".concat(i," on state '").concat(t.id,"' are unreachable. ")+"Make sure that the default transition is the last one defined.")},ii=function(){function t(e,r,n,i){n===void 0&&(n="context"in e?e.context:void 0);var s=this,o;this.config=e,this._context=n,this.order=-1,this.__xstatenode=!0,this.__cache={events:void 0,relativeValue:new Map,initialStateValue:void 0,initialState:void 0,on:void 0,transitions:void 0,candidates:{},delayedTransitions:void 0},this.idMap={},this.tags=[],this.options=Object.assign(ri(),r),this.parent=i==null?void 0:i.parent,this.key=this.config.key||(i==null?void 0:i.key)||this.config.id||"(machine)",this.machine=this.parent?this.parent.machine:this,this.path=this.parent?this.parent.path.concat(this.key):[],this.delimiter=this.config.delimiter||(this.parent?this.parent.delimiter:tr),this.id=this.config.id||G([this.machine.key],N(this.path),!1).join(this.delimiter),this.version=this.parent?this.parent.version:this.config.version,this.type=this.config.type||(this.config.parallel?"parallel":this.config.states&&Object.keys(this.config.states).length?"compound":this.config.history?"history":"atomic"),this.schema=this.parent?this.machine.schema:(o=this.config.schema)!==null&&o!==void 0?o:{},this.description=this.config.description,W||X(!("parallel"in this.config),'The "parallel" property is deprecated and will be removed in version 4.1. '.concat(this.config.parallel?"Replace with `type: 'parallel'`":"Use `type: '".concat(this.type,"'`")," in the config for state node '").concat(this.id,"' instead.")),this.initial=this.config.initial,this.states=this.config.states?De(this.config.states,function(f,h){var y,a=new t(f,{},void 0,{parent:s,key:h});return Object.assign(s.idMap,w((y={},y[a.id]=a,y),a.idMap)),a}):_e;var l=0;function u(f){var h,y;f.order=l++;try{for(var a=I(pr(f)),c=a.next();!c.done;c=a.next()){var d=c.value;u(d)}}catch(p){h={error:p}}finally{try{c&&!c.done&&(y=a.return)&&y.call(a)}finally{if(h)throw h.error}}}u(this),this.history=this.config.history===!0?"shallow":this.config.history||!1,this._transient=!!this.config.always||(this.config.on?Array.isArray(this.config.on)?this.config.on.some(function(f){var h=f.event;return h===Ae}):Ae in this.config.on:!1),this.strict=!!this.config.strict,this.onEntry=oe(this.config.entry||this.config.onEntry).map(function(f){return Ce(f)}),this.onExit=oe(this.config.exit||this.config.onExit).map(function(f){return Ce(f)}),this.meta=this.config.meta,this.doneData=this.type==="final"?this.config.data:void 0,this.invoke=oe(this.config.invoke).map(function(f,h){var y,a;if(pe(f)){var c=Je(s.id,h);return s.machine.options.services=w((y={},y[c]=f,y),s.machine.options.services),it({src:c,id:c})}else if(x(f.src)){var c=f.id||Je(s.id,h);return it(w(w({},f),{id:c,src:f.src}))}else if(pe(f.src)||D(f.src)){var c=f.id||Je(s.id,h);return s.machine.options.services=w((a={},a[c]=f.src,a),s.machine.options.services),it(w(w({id:c},f),{src:c}))}else{var d=f.src;return it(w(w({id:Je(s.id,h)},f),{src:d}))}}),this.activities=oe(this.config.activities).concat(this.invoke).map(function(f){return Rt(f)}),this.transition=this.transition.bind(this),this.tags=oe(this.config.tags)}return t.prototype._init=function(){this.__cache.transitions||yr(this).forEach(function(e){return e.on})},t.prototype.withConfig=function(e,r){var n=this.options,i=n.actions,s=n.activities,o=n.guards,l=n.services,u=n.delays;return new t(this.config,{actions:w(w({},i),e.actions),activities:w(w({},s),e.activities),guards:w(w({},o),e.guards),services:w(w({},l),e.services),delays:w(w({},u),e.delays)},r!=null?r:this.context)},t.prototype.withContext=function(e){return new t(this.config,this.options,e)},Object.defineProperty(t.prototype,"context",{get:function(){return D(this._context)?this._context():this._context},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"definition",{get:function(){return{id:this.id,key:this.key,version:this.version,context:this.context,type:this.type,initial:this.initial,history:this.history,states:De(this.states,function(e){return e.definition}),on:this.on,transitions:this.transitions,entry:this.onEntry,exit:this.onExit,activities:this.activities||[],meta:this.meta,order:this.order||-1,data:this.doneData,invoke:this.invoke,description:this.description,tags:this.tags}},enumerable:!1,configurable:!0}),t.prototype.toJSON=function(){return this.definition},Object.defineProperty(t.prototype,"on",{get:function(){if(this.__cache.on)return this.__cache.on;var e=this.transitions;return this.__cache.on=e.reduce(function(r,n){return r[n.eventType]=r[n.eventType]||[],r[n.eventType].push(n),r},{})},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"after",{get:function(){return this.__cache.delayedTransitions||(this.__cache.delayedTransitions=this.getDelayedTransitions(),this.__cache.delayedTransitions)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"transitions",{get:function(){return this.__cache.transitions||(this.__cache.transitions=this.formatTransitions(),this.__cache.transitions)},enumerable:!1,configurable:!0}),t.prototype.getCandidates=function(e){if(this.__cache.candidates[e])return this.__cache.candidates[e];var r=e===Ae,n=this.transitions.filter(function(i){var s=i.eventType===e;return r?s:s||i.eventType===Ve});return this.__cache.candidates[e]=n,n},t.prototype.getDelayedTransitions=function(){var e=this,r=this.config.after;if(!r)return[];var n=function(s,o){var l=D(s)?"".concat(e.id,":delay[").concat(o,"]"):s,u=Ln(l,e.id);return e.onEntry.push(dr(u,{delay:s})),e.onExit.push(xn(u)),u},i=Ee(r)?r.map(function(s,o){var l=n(s.delay,o);return w(w({},s),{event:l})}):H(Object.keys(r).map(function(s,o){var l=r[s],u=x(l)?{target:l}:l,f=isNaN(+s)?s:+s,h=n(f,o);return oe(u).map(function(y){return w(w({},y),{event:h,delay:f})})}));return i.map(function(s){var o=s.delay;return w(w({},e.formatTransition(s)),{delay:o})})},t.prototype.getStateNodes=function(e){var r,n=this;if(!e)return[];var i=e instanceof ue?e.value:xe(e,this.delimiter);if(x(i)){var s=this.getStateNode(i).initial;return s!==void 0?this.getStateNodes((r={},r[i]=s,r)):[this,this.states[i]]}var o=Object.keys(i),l=[this];return l.push.apply(l,G([],N(H(o.map(function(u){return n.getStateNode(u).getStateNodes(i[u])}))),!1)),l},t.prototype.handles=function(e){var r=nr(e);return this.events.includes(r)},t.prototype.resolveState=function(e){var r=e instanceof ue?e:ue.create(e),n=Array.from(Le([],this.getStateNodes(r.value)));return new ue(w(w({},r),{value:this.resolve(r.value),configuration:n,done:nt(n,this),tags:gr(n),machine:this.machine}))},t.prototype.transitionLeafNode=function(e,r,n){var i=this.getStateNode(e),s=i.next(r,n);return!s||!s.transitions.length?this.next(r,n):s},t.prototype.transitionCompoundNode=function(e,r,n){var i=Object.keys(e),s=this.getStateNode(i[0]),o=s._transition(e[i[0]],r,n);return!o||!o.transitions.length?this.next(r,n):o},t.prototype.transitionParallelNode=function(e,r,n){var i,s,o={};try{for(var l=I(Object.keys(e)),u=l.next();!u.done;u=l.next()){var f=u.value,h=e[f];if(h){var y=this.getStateNode(f),a=y._transition(h,r,n);a&&(o[f]=a)}}}catch(m){i={error:m}}finally{try{u&&!u.done&&(s=l.return)&&s.call(l)}finally{if(i)throw i.error}}var c=Object.keys(o).map(function(m){return o[m]}),d=H(c.map(function(m){return m.transitions})),p=c.some(function(m){return m.transitions.length>0});if(!p)return this.next(r,n);var E=H(Object.keys(o).map(function(m){return o[m].configuration}));return{transitions:d,exitSet:H(c.map(function(m){return m.exitSet})),configuration:E,source:r,actions:H(Object.keys(o).map(function(m){return o[m].actions}))}},t.prototype._transition=function(e,r,n){return x(e)?this.transitionLeafNode(e,r,n):Object.keys(e).length===1?this.transitionCompoundNode(e,r,n):this.transitionParallelNode(e,r,n)},t.prototype.getTransitionData=function(e,r){return this._transition(e.value,e,Q(r))},t.prototype.next=function(e,r){var n,i,s=this,o=r.name,l=[],u=[],f;try{for(var h=I(this.getCandidates(o)),y=h.next();!y.done;y=h.next()){var a=y.value,c=a.cond,d=a.in,p=e.context,E=d?x(d)&&be(d)?e.matches(xe(this.getStateNodeById(d).path,this.delimiter)):Et(xe(d,this.delimiter),gn(this.path.slice(0,-2))(e.value)):!0,m=!1;try{m=!c||lr(this.machine,c,p,r,e)}catch(b){throw new Error("Unable to evaluate guard '".concat(c.name||c.type,"' in transition for event '").concat(o,"' in state node '").concat(this.id,`':
`).concat(b.message))}if(m&&E){a.target!==void 0&&(u=a.target),l.push.apply(l,G([],N(a.actions),!1)),f=a;break}}}catch(b){n={error:b}}finally{try{y&&!y.done&&(i=h.return)&&i.call(h)}finally{if(n)throw n.error}}if(f){if(!u.length)return{transitions:[f],exitSet:[],configuration:e.value?[this]:[],source:e,actions:l};var S=H(u.map(function(b){return s.getRelativeStateNodes(b,e.historyValue)})),R=!!f.internal;return{transitions:[f],exitSet:R?[]:H(u.map(function(b){return s.getPotentiallyReenteringNodes(b)})),configuration:S,source:e,actions:l}}},t.prototype.getPotentiallyReenteringNodes=function(e){if(this.order<e.order)return[this];for(var r=[],n=this,i=e;n&&n!==i;)r.push(n),n=n.parent;return n!==i?[]:(r.push(i),r)},t.prototype.getActions=function(e,r,n,i,s,o,l){var u,f,h,y,a=this,c=o?Le([],this.getStateNodes(o.value)):[],d=new Set;try{for(var p=I(Array.from(e).sort(function(_,K){return _.order-K.order})),E=p.next();!E.done;E=p.next()){var m=E.value;(!je(c,m)||je(n.exitSet,m)||m.parent&&d.has(m.parent))&&d.add(m)}}catch(_){u={error:_}}finally{try{E&&!E.done&&(f=p.return)&&f.call(p)}finally{if(u)throw u.error}}try{for(var S=I(c),R=S.next();!R.done;R=S.next()){var m=R.value;(!je(e,m)||je(n.exitSet,m.parent))&&n.exitSet.push(m)}}catch(_){h={error:_}}finally{try{R&&!R.done&&(y=S.return)&&y.call(S)}finally{if(h)throw h.error}}n.exitSet.sort(function(_,K){return K.order-_.order});var b=Array.from(d).sort(function(_,K){return _.order-K.order}),j=new Set(n.exitSet),C=H(b.map(function(_){var K=[];if(_.type!=="final")return K;var Y=_.parent;if(!Y.parent)return K;K.push(Ze(_.id,_.doneData),Ze(Y.id,_.doneData?ze(_.doneData,i,s):void 0));var F=Y.parent;return F.type==="parallel"&&Me(F).every(function(ye){return nt(n.configuration,ye)})&&K.push(Ze(F.id)),K})),k=b.map(function(_){var K=_.onEntry,Y=_.activities.map(function(F){return Dn(F)});return{type:"entry",actions:de(l?G(G([],N(K),!1),N(Y),!1):G(G([],N(Y),!1),N(K),!1),a.machine.options.actions)}}).concat({type:"state_done",actions:C.map(function(_){return In(_)})}),M=Array.from(j).map(function(_){return{type:"exit",actions:de(G(G([],N(_.onExit),!1),N(_.activities.map(function(K){return Cn(K)})),!1),a.machine.options.actions)}}),O=M.concat({type:"transition",actions:de(n.actions,this.machine.options.actions)}).concat(k);if(r){var $=de(H(G([],N(e),!1).sort(function(_,K){return K.order-_.order}).map(function(_){return _.onExit})),this.machine.options.actions).filter(function(_){return!wt(_)});return O.concat({type:"stop",actions:$})}return O},t.prototype.transition=function(e,r,n,i){e===void 0&&(e=this.initialState);var s=Q(r),o;if(e instanceof ue)o=n===void 0?e:this.resolveState(ue.from(e,n));else{var l=x(e)?this.resolve(Ye(this.getResolvedPath(e))):this.resolve(e),u=n!=null?n:this.machine.context;o=this.resolveState(ue.from(l,u))}if(!W&&s.name===Ve)throw new Error("An event cannot have the wildcard type ('".concat(Ve,"')"));if(this.strict&&!this.events.includes(s.name)&&!Tn(s.name))throw new Error("Machine '".concat(this.id,"' does not accept event '").concat(s.name,"'"));var f=this._transition(o.value,o,s)||{transitions:[],configuration:[],exitSet:[],source:o,actions:[]},h=Le([],this.getStateNodes(o.value)),y=f.configuration.length?Le(h,f.configuration):h;return f.configuration=G([],N(y),!1),this.resolveTransition(f,o,o.context,i,s)},t.prototype.resolveRaisedTransition=function(e,r,n,i){var s,o=e.actions;return e=this.transition(e,r,void 0,i),e._event=n,e.event=n.data,(s=e.actions).unshift.apply(s,G([],N(o),!1)),e},t.prototype.resolveTransition=function(e,r,n,i,s){var o,l,u,f,h=this;s===void 0&&(s=we);var y=e.configuration,a=!r||e.transitions.length>0,c=a?e.configuration:r?r.configuration:[],d=nt(c,this),p=a?Fn(this.machine,y):void 0,E=r?r.historyValue?r.historyValue:e.source?this.machine.historyValue(r.value):void 0:void 0,m=this.getActions(new Set(c),d,e,n,s,r,i),S=r?w({},r.activities):{};try{for(var R=I(m),b=R.next();!b.done;b=R.next()){var j=b.value;try{for(var C=(u=void 0,I(j.actions)),k=C.next();!k.done;k=C.next()){var M=k.value;M.type===vt?S[M.activity.id||M.activity.type]=M:M.type===pt&&(S[M.activity.id||M.activity.type]=!1)}}catch(ne){u={error:ne}}finally{try{k&&!k.done&&(f=C.return)&&f.call(C)}finally{if(u)throw u.error}}}}catch(ne){o={error:ne}}finally{try{b&&!b.done&&(l=R.return)&&l.call(R)}finally{if(o)throw o.error}}var O=N(tt(this,r,n,s,m,i,this.machine.config.predictableActionArguments||this.machine.config.preserveActionOrder),2),$=O[0],_=O[1],K=N(Sn($,wt),2),Y=K[0],F=K[1],ye=$.filter(function(ne){var z;return ne.type===vt&&((z=ne.activity)===null||z===void 0?void 0:z.type)===mt}),me=ye.reduce(function(ne,z){return ne[z.activity.id]=Kn(z.activity,h.machine,_,s),ne},r?w({},r.children):{}),v=new ue({value:p||r.value,context:_,_event:s,_sessionid:r?r._sessionid:null,historyValue:p?E?Rn(E,p):void 0:r?r.historyValue:void 0,history:!p||e.source?r:void 0,actions:p?F:[],activities:p?S:r?r.activities:{},events:[],configuration:c,transitions:e.transitions,children:me,done:d,tags:gr(c),machine:this}),g=n!==_;v.changed=s.name===er||g;var A=v.history;A&&delete A.history;var V=!d&&(this._transient||y.some(function(ne){return ne._transient}));if(!a&&(!V||s.name===Ae))return v;var P=v;if(!d)for(V&&(P=this.resolveRaisedTransition(P,{type:fn},s,i));Y.length;){var U=Y.shift();P=this.resolveRaisedTransition(P,U._event,s,i)}var Ie=P.changed||(A?!!P.actions.length||g||typeof A.value!=typeof P.value||!Er(P.value,A.value):void 0);return P.changed=Ie,P.history=A,P},t.prototype.getStateNode=function(e){if(be(e))return this.machine.getStateNodeById(e);if(!this.states)throw new Error("Unable to retrieve child state '".concat(e,"' from '").concat(this.id,"'; no child states exist."));var r=this.states[e];if(!r)throw new Error("Child state '".concat(e,"' does not exist on '").concat(this.id,"'"));return r},t.prototype.getStateNodeById=function(e){var r=be(e)?e.slice(Ot.length):e;if(r===this.id)return this;var n=this.machine.idMap[r];if(!n)throw new Error("Child state node '#".concat(r,"' does not exist on machine '").concat(this.id,"'"));return n},t.prototype.getStateNodeByPath=function(e){if(typeof e=="string"&&be(e))try{return this.getStateNodeById(e.slice(1))}catch{}for(var r=Tt(e,this.delimiter).slice(),n=this;r.length;){var i=r.shift();if(!i.length)break;n=n.getStateNode(i)}return n},t.prototype.resolve=function(e){var r,n=this;if(!e)return this.initialStateValue||_e;switch(this.type){case"parallel":return De(this.initialStateValue,function(s,o){return s?n.getStateNode(o).resolve(e[o]||s):_e});case"compound":if(x(e)){var i=this.getStateNode(e);return i.type==="parallel"||i.type==="compound"?(r={},r[e]=i.initialStateValue,r):e}return Object.keys(e).length?De(e,function(s,o){return s?n.getStateNode(o).resolve(s):_e}):this.initialStateValue||{};default:return e||_e}},t.prototype.getResolvedPath=function(e){if(be(e)){var r=this.machine.idMap[e.slice(Ot.length)];if(!r)throw new Error("Unable to find state node '".concat(e,"'"));return r.path}return Tt(e,this.delimiter)},Object.defineProperty(t.prototype,"initialStateValue",{get:function(){var e;if(this.__cache.initialStateValue)return this.__cache.initialStateValue;var r;if(this.type==="parallel")r=ir(this.states,function(n){return n.initialStateValue||_e},function(n){return n.type!=="history"});else if(this.initial!==void 0){if(!this.states[this.initial])throw new Error("Initial state '".concat(this.initial,"' not found on '").concat(this.key,"'"));r=rt(this.states[this.initial])?this.initial:(e={},e[this.initial]=this.states[this.initial].initialStateValue,e)}else r={};return this.__cache.initialStateValue=r,this.__cache.initialStateValue},enumerable:!1,configurable:!0}),t.prototype.getInitialState=function(e,r){this._init();var n=this.getStateNodes(e);return this.resolveTransition({configuration:n,exitSet:[],transitions:[],source:void 0,actions:[]},void 0,r!=null?r:this.machine.context,void 0)},Object.defineProperty(t.prototype,"initialState",{get:function(){var e=this.initialStateValue;if(!e)throw new Error("Cannot retrieve initial state from simple state '".concat(this.id,"'."));return this.getInitialState(e)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"target",{get:function(){var e;if(this.type==="history"){var r=this.config;x(r.target)?e=be(r.target)?Ye(this.machine.getStateNodeById(r.target).path.slice(this.path.length-1)):r.target:e=r.target}return e},enumerable:!1,configurable:!0}),t.prototype.getRelativeStateNodes=function(e,r,n){return n===void 0&&(n=!0),n?e.type==="history"?e.resolveHistory(r):e.initialStateNodes:[e]},Object.defineProperty(t.prototype,"initialStateNodes",{get:function(){var e=this;if(rt(this))return[this];if(this.type==="compound"&&!this.initial)return W||X(!1,"Compound state node '".concat(this.id,"' has no initial state.")),[this];var r=qe(this.initialStateValue);return H(r.map(function(n){return e.getFromRelativePath(n)}))},enumerable:!1,configurable:!0}),t.prototype.getFromRelativePath=function(e){if(!e.length)return[this];var r=N(e),n=r[0],i=r.slice(1);if(!this.states)throw new Error("Cannot retrieve subPath '".concat(n,"' from node with no states"));var s=this.getStateNode(n);if(s.type==="history")return s.resolveHistory();if(!this.states[n])throw new Error("Child state '".concat(n,"' does not exist on '").concat(this.id,"'"));return this.states[n].getFromRelativePath(i)},t.prototype.historyValue=function(e){if(Object.keys(this.states).length)return{current:e||this.initialStateValue,states:ir(this.states,function(r,n){if(!e)return r.historyValue();var i=x(e)?void 0:e[n];return r.historyValue(i||r.initialStateValue)},function(r){return!r.history})}},t.prototype.resolveHistory=function(e){var r=this;if(this.type!=="history")return[this];var n=this.parent;if(!e){var i=this.target;return i?H(qe(i).map(function(o){return n.getFromRelativePath(o)})):n.initialStateNodes}var s=En(n.path,"states")(e).current;return x(s)?[n.getStateNode(s)]:H(qe(s).map(function(o){return r.history==="deep"?n.getFromRelativePath(o):[n.states[o[0]]]}))},Object.defineProperty(t.prototype,"stateIds",{get:function(){var e=this,r=H(Object.keys(this.states).map(function(n){return e.states[n].stateIds}));return[this.id].concat(r)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"events",{get:function(){var e,r,n,i;if(this.__cache.events)return this.__cache.events;var s=this.states,o=new Set(this.ownEvents);if(s)try{for(var l=I(Object.keys(s)),u=l.next();!u.done;u=l.next()){var f=u.value,h=s[f];if(h.states)try{for(var y=(n=void 0,I(h.events)),a=y.next();!a.done;a=y.next()){var c=a.value;o.add("".concat(c))}}catch(d){n={error:d}}finally{try{a&&!a.done&&(i=y.return)&&i.call(y)}finally{if(n)throw n.error}}}}catch(d){e={error:d}}finally{try{u&&!u.done&&(r=l.return)&&r.call(l)}finally{if(e)throw e.error}}return this.__cache.events=Array.from(o)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"ownEvents",{get:function(){var e=new Set(this.transitions.filter(function(r){return!(!r.target&&!r.actions.length&&r.internal)}).map(function(r){return r.eventType}));return Array.from(e)},enumerable:!1,configurable:!0}),t.prototype.resolveTarget=function(e){var r=this;if(e!==void 0)return e.map(function(n){if(!x(n))return n;var i=n[0]===r.delimiter;if(i&&!r.parent)return r.getStateNodeByPath(n.slice(1));var s=i?r.key+n:n;if(r.parent)try{var o=r.parent.getStateNodeByPath(s);return o}catch(l){throw new Error("Invalid transition definition for state node '".concat(r.id,`':
`).concat(l.message))}else return r.getStateNodeByPath(s)})},t.prototype.formatTransition=function(e){var r=this,n=bn(e.target),i="internal"in e?e.internal:n?n.some(function(u){return x(u)&&u[0]===r.delimiter}):!0,s=this.machine.options.guards,o=this.resolveTarget(n),l=w(w({},e),{actions:de(oe(e.actions)),cond:ur(e.cond,s),target:o,source:this,internal:i,eventType:e.event,toJSON:function(){return w(w({},l),{target:l.target?l.target.map(function(u){return"#".concat(u.id)}):void 0,source:"#".concat(r.id)})}});return l},t.prototype.formatTransitions=function(){var e,r,n=this,i;if(!this.config.on)i=[];else if(Array.isArray(this.config.on))i=this.config.on;else{var s=this.config.on,o=Ve,l=s[o],u=l===void 0?[]:l,f=ht(s,[typeof o=="symbol"?o:o+""]);i=H(Object.keys(f).map(function(S){!W&&S===Ae&&X(!1,"Empty string transition configs (e.g., `{ on: { '': ... }}`) for transient transitions are deprecated. Specify the transition in the `{ always: ... }` property instead. "+'Please check the `on` configuration for "#'.concat(n.id,'".'));var R=Te(S,f[S]);return W||ni(n,S,R),R}).concat(Te(Ve,u)))}var h=this.config.always?Te("",this.config.always):[],y=this.config.onDone?Te(String(Ze(this.id)),this.config.onDone):[];W||X(!(this.config.onDone&&!this.parent),'Root nodes cannot have an ".onDone" transition. Please check the config of "'.concat(this.id,'".'));var a=H(this.invoke.map(function(S){var R=[];return S.onDone&&R.push.apply(R,G([],N(Te(String(et(S.id)),S.onDone)),!1)),S.onError&&R.push.apply(R,G([],N(Te(String(Ue(S.id)),S.onError)),!1)),R})),c=this.after,d=H(G(G(G(G([],N(y),!1),N(a),!1),N(i),!1),N(h),!1).map(function(S){return oe(S).map(function(R){return n.formatTransition(R)})}));try{for(var p=I(c),E=p.next();!E.done;E=p.next()){var m=E.value;d.push(m)}}catch(S){e={error:S}}finally{try{E&&!E.done&&(r=p.return)&&r.call(p)}finally{if(e)throw e.error}}return d},t}(),wr=!1;function Oe(t,e){return!W&&!("predictableActionArguments"in t)&&!wr&&(wr=!0,console.warn("It is highly recommended to set `predictableActionArguments` to `true` when using `createMachine`. https://xstate.js.org/docs/guides/actions.html")),new ii(t,e)}var B=Mn,ee=dr;const st={user:null,mfa:null,accessToken:{value:null,expiresAt:null,expiresInSeconds:15},refreshTimer:{startedAt:null,attempts:0,lastAttempt:null},refreshToken:{value:null},importTokenAttempts:0,errors:{}};function si(t){return new TextEncoder().encode(t)}function le(t){const e=new Uint8Array(t);let r="";for(const i of e)r+=String.fromCharCode(i);return btoa(r).replace(/\+/g,"-").replace(/\//g,"_").replace(/=/g,"")}function It(t){const e=t.replace(/-/g,"+").replace(/_/g,"/"),r=(4-e.length%4)%4,n=e.padEnd(e.length+r,"="),i=atob(n),s=new ArrayBuffer(i.length),o=new Uint8Array(s);for(let l=0;l<i.length;l++)o[l]=i.charCodeAt(l);return s}function Sr(){return(window==null?void 0:window.PublicKeyCredential)!==void 0&&typeof window.PublicKeyCredential=="function"}function Rr(t){const{id:e}=t;return{...t,id:It(e),transports:t.transports}}function Ar(t){return t==="localhost"||/^([a-z0-9]+(-[a-z0-9]+)*\.)+[a-z]{2,}$/i.test(t)}class J extends Error{constructor({message:e,code:r,cause:n,name:i}){super(e,{cause:n}),this.name=i!=null?i:n.name,this.code=r}}function oi({error:t,options:e}){var n,i;const{publicKey:r}=e;if(!r)throw Error("options was missing required publicKey property");if(t.name==="AbortError"){if(e.signal instanceof AbortSignal)return new J({message:"Registration ceremony was sent an abort signal",code:"ERROR_CEREMONY_ABORTED",cause:t})}else if(t.name==="ConstraintError"){if(((n=r.authenticatorSelection)==null?void 0:n.requireResidentKey)===!0)return new J({message:"Discoverable credentials were required but no available authenticator supported it",code:"ERROR_AUTHENTICATOR_MISSING_DISCOVERABLE_CREDENTIAL_SUPPORT",cause:t});if(((i=r.authenticatorSelection)==null?void 0:i.userVerification)==="required")return new J({message:"User verification was required but no available authenticator supported it",code:"ERROR_AUTHENTICATOR_MISSING_USER_VERIFICATION_SUPPORT",cause:t})}else{if(t.name==="InvalidStateError")return new J({message:"The authenticator was previously registered",code:"ERROR_AUTHENTICATOR_PREVIOUSLY_REGISTERED",cause:t});if(t.name==="NotAllowedError")return new J({message:t.message,code:"ERROR_PASSTHROUGH_SEE_CAUSE_PROPERTY",cause:t});if(t.name==="NotSupportedError")return r.pubKeyCredParams.filter(o=>o.type==="public-key").length===0?new J({message:'No entry in pubKeyCredParams was of type "public-key"',code:"ERROR_MALFORMED_PUBKEYCREDPARAMS",cause:t}):new J({message:"No available authenticator supported any of the specified pubKeyCredParams algorithms",code:"ERROR_AUTHENTICATOR_NO_SUPPORTED_PUBKEYCREDPARAMS_ALG",cause:t});if(t.name==="SecurityError"){const s=window.location.hostname;if(Ar(s)){if(r.rp.id!==s)return new J({message:`The RP ID "${r.rp.id}" is invalid for this domain`,code:"ERROR_INVALID_RP_ID",cause:t})}else return new J({message:`${window.location.hostname} is an invalid domain`,code:"ERROR_INVALID_DOMAIN",cause:t})}else if(t.name==="TypeError"){if(r.user.id.byteLength<1||r.user.id.byteLength>64)return new J({message:"User ID was not between 1 and 64 characters",code:"ERROR_INVALID_USER_ID_LENGTH",cause:t})}else if(t.name==="UnknownError")return new J({message:"The authenticator was unable to process the specified options, or could not create a new credential",code:"ERROR_AUTHENTICATOR_GENERAL_ERROR",cause:t})}return t}class ai{createNewAbortSignal(){if(this.controller){const r=new Error("Cancelling existing WebAuthn API call for new one");r.name="AbortError",this.controller.abort(r)}const e=new AbortController;return this.controller=e,e.signal}cancelCeremony(){if(this.controller){const e=new Error("Manually cancelling existing WebAuthn API call");e.name="AbortError",this.controller.abort(e),this.controller=void 0}}}const _r=new ai,ci=["cross-platform","platform"];function br(t){if(t&&!(ci.indexOf(t)<0))return t}async function Or(t){var a;if(!Sr())throw new Error("WebAuthn is not supported in this browser");const r={publicKey:{...t,challenge:It(t.challenge),user:{...t.user,id:si(t.user.id)},excludeCredentials:(a=t.excludeCredentials)==null?void 0:a.map(Rr)}};r.signal=_r.createNewAbortSignal();let n;try{n=await navigator.credentials.create(r)}catch(c){throw oi({error:c,options:r})}if(!n)throw new Error("Registration was not completed");const{id:i,rawId:s,response:o,type:l}=n;let u;typeof o.getTransports=="function"&&(u=o.getTransports());let f;if(typeof o.getPublicKeyAlgorithm=="function")try{f=o.getPublicKeyAlgorithm()}catch(c){kt("getPublicKeyAlgorithm()",c)}let h;if(typeof o.getPublicKey=="function")try{const c=o.getPublicKey();c!==null&&(h=le(c))}catch(c){kt("getPublicKey()",c)}let y;if(typeof o.getAuthenticatorData=="function")try{y=le(o.getAuthenticatorData())}catch(c){kt("getAuthenticatorData()",c)}return{id:i,rawId:le(s),response:{attestationObject:le(o.attestationObject),clientDataJSON:le(o.clientDataJSON),transports:u,publicKeyAlgorithm:f,publicKey:h,authenticatorData:y},type:l,clientExtensionResults:n.getClientExtensionResults(),authenticatorAttachment:br(n.authenticatorAttachment)}}function kt(t,e){console.warn(`The browser extension that intercepted this WebAuthn API call incorrectly implemented ${t}. You should report this error to them.
`,e)}function ui(t){return new TextDecoder("utf-8").decode(t)}function li(){const t=window.PublicKeyCredential;return t.isConditionalMediationAvailable===void 0?new Promise(e=>e(!1)):t.isConditionalMediationAvailable()}function fi({error:t,options:e}){const{publicKey:r}=e;if(!r)throw Error("options was missing required publicKey property");if(t.name==="AbortError"){if(e.signal instanceof AbortSignal)return new J({message:"Authentication ceremony was sent an abort signal",code:"ERROR_CEREMONY_ABORTED",cause:t})}else{if(t.name==="NotAllowedError")return new J({message:t.message,code:"ERROR_PASSTHROUGH_SEE_CAUSE_PROPERTY",cause:t});if(t.name==="SecurityError"){const n=window.location.hostname;if(Ar(n)){if(r.rpId!==n)return new J({message:`The RP ID "${r.rpId}" is invalid for this domain`,code:"ERROR_INVALID_RP_ID",cause:t})}else return new J({message:`${window.location.hostname} is an invalid domain`,code:"ERROR_INVALID_DOMAIN",cause:t})}else if(t.name==="UnknownError")return new J({message:"The authenticator was unable to process the specified options, or could not create a new assertion signature",code:"ERROR_AUTHENTICATOR_GENERAL_ERROR",cause:t})}return t}async function Pt(t,e=!1){var y,a;if(!Sr())throw new Error("WebAuthn is not supported in this browser");let r;((y=t.allowCredentials)==null?void 0:y.length)!==0&&(r=(a=t.allowCredentials)==null?void 0:a.map(Rr));const n={...t,challenge:It(t.challenge),allowCredentials:r},i={};if(e){if(!await li())throw Error("Browser does not support WebAuthn autofill");if(document.querySelectorAll("input[autocomplete$='webauthn']").length<1)throw Error('No <input> with "webauthn" as the only or last value in its `autocomplete` attribute was detected');i.mediation="conditional",n.allowCredentials=[]}i.publicKey=n,i.signal=_r.createNewAbortSignal();let s;try{s=await navigator.credentials.get(i)}catch(c){throw fi({error:c,options:i})}if(!s)throw new Error("Authentication was not completed");const{id:o,rawId:l,response:u,type:f}=s;let h;return u.userHandle&&(h=ui(u.userHandle)),{id:o,rawId:le(l),response:{authenticatorData:le(u.authenticatorData),clientDataJSON:le(u.clientDataJSON),signature:le(u.signature),userHandle:h},type:f,clientExtensionResults:s.getClientExtensionResults(),authenticatorAttachment:br(s.authenticatorAttachment)}}/*! js-cookie v3.0.5 | MIT */function ot(t){for(var e=1;e<arguments.length;e++){var r=arguments[e];for(var n in r)t[n]=r[n]}return t}var di={read:function(t){return t[0]==='"'&&(t=t.slice(1,-1)),t.replace(/(%[\dA-F]{2})+/gi,decodeURIComponent)},write:function(t){return encodeURIComponent(t).replace(/%(2[346BF]|3[AC-F]|40|5[BDE]|60|7[BCD])/g,decodeURIComponent)}};function Nt(t,e){function r(i,s,o){if(typeof document!="undefined"){o=ot({},e,o),typeof o.expires=="number"&&(o.expires=new Date(Date.now()+o.expires*864e5)),o.expires&&(o.expires=o.expires.toUTCString()),i=encodeURIComponent(i).replace(/%(2[346B]|5E|60|7C)/g,decodeURIComponent).replace(/[()]/g,escape);var l="";for(var u in o)o[u]&&(l+="; "+u,o[u]!==!0&&(l+="="+o[u].split(";")[0]));return document.cookie=i+"="+t.write(s,i)+l}}function n(i){if(!(typeof document=="undefined"||arguments.length&&!i)){for(var s=document.cookie?document.cookie.split("; "):[],o={},l=0;l<s.length;l++){var u=s[l].split("="),f=u.slice(1).join("=");try{var h=decodeURIComponent(u[0]);if(o[h]=t.read(f,h),i===h)break}catch{}}return i?o[i]:o}}return Object.create({set:r,get:n,remove:function(i,s){r(i,"",ot({},s,{expires:-1}))},withAttributes:function(i){return Nt(this.converter,ot({},this.attributes,i))},withConverter:function(i){return Nt(ot({},this.converter,i),this.attributes)}},{attributes:{value:Object.freeze(e)},converter:{value:Object.freeze(t)}})}var xt=Nt(di,{path:"/"});const at=typeof window!="undefined",ct=new Map,hi=t=>{var e;return at&&typeof localStorage!="undefined"?localStorage.getItem(t):(e=ct.get(t))!=null?e:null},vi=(t,e)=>{at&&typeof localStorage!="undefined"?e?localStorage.setItem(t,e):localStorage.removeItem(t):e?ct.set(t,e):ct.has(t)&&ct.delete(t)},Ir=(t,e)=>{if(t==="localStorage"||t==="web")return hi;if(t==="cookie")return r=>{var n;return at&&(n=xt.get(r))!=null?n:null};if(!e)throw Error(`clientStorageType is set to '${t}' but no clientStorage has been given`);if(t==="react-native")return r=>{var n;return(n=e.getItem)==null?void 0:n.call(e,r)};if(t==="capacitor")return r=>{var n;return(n=e.get)==null?void 0:n.call(e,{key:r})};if(t==="expo-secure-storage")return r=>{var n;return(n=e.getItemAsync)==null?void 0:n.call(e,r)};if(t==="custom"){if(e.getItem&&e.removeItem)return e.getItem;if(e.getItemAsync)return e.getItemAsync;throw Error(`clientStorageType is set to 'custom' but clientStorage is missing either "getItem" and "removeItem" properties or "getItemAsync" property`)}throw Error(`Unknown storage type: ${t}`)},kr=(t,e)=>{if(t==="localStorage"||t==="web")return vi;if(t==="cookie")return(r,n)=>{at&&(n?xt.set(r,n,{expires:30,sameSite:"lax",httpOnly:!1}):xt.remove(r))};if(!e)throw Error(`clientStorageType is set to '${t}' but no clienStorage has been given`);if(t==="react-native")return(r,n)=>{var i,s;return n?(i=e.setItem)==null?void 0:i.call(e,r,n):(s=e.removeItem)==null?void 0:s.call(e,r)};if(t==="capacitor")return(r,n)=>{var i,s;return n?(i=e.set)==null?void 0:i.call(e,{key:r,value:n}):(s=e.remove)==null?void 0:s.call(e,{key:r})};if(t==="expo-secure-storage")return async(r,n)=>{var i,s;return n?(i=e.setItemAsync)==null?void 0:i.call(e,r,n):(s=e.deleteItemAsync)==null?void 0:s.call(e,r)};if(t==="custom"){if(!e.removeItem)throw Error("clientStorageType is set to 'custom' but clientStorage is missing a removeItem property");if(e.setItem)return(r,n)=>{var i,s;return n?(i=e.setItem)==null?void 0:i.call(e,r,n):(s=e.removeItem)==null?void 0:s.call(e,r)};if(e.setItemAsync)return async(r,n)=>{var i,s;return n?(i=e.setItemAsync)==null?void 0:i.call(e,r,n):(s=e.removeItem)==null?void 0:s.call(e,r)};throw Error("clientStorageType is set to 'custom' but clientStorage is missing setItem or setItemAsync property")}throw Error(`Unknown storage type: ${t}`)},Ge=t=>!t||!t.accessToken.value||!t.accessToken.expiresAt||!t.user?null:{accessToken:t.accessToken.value,accessTokenExpiresIn:(t.accessToken.expiresAt.getTime()-Date.now())/1e3,refreshToken:t.refreshToken.value,user:t.user},ie=({accessToken:t,refreshToken:e,isError:r,user:n,error:i})=>r?{session:null,error:i}:n&&t?{session:{accessToken:t,accessTokenExpiresIn:0,refreshToken:e,user:n},error:null}:{session:null,error:null},Be=()=>typeof window!="undefined"&&typeof window.location!="undefined";var Dt=typeof globalThis!="undefined"?globalThis:typeof window!="undefined"?window:typeof global!="undefined"?global:typeof self!="undefined"?self:{};function pi(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}var Ct={exports:{}};(function(t,e){(function(r){function n(i){var s=i&&i.Promise||r.Promise,o=i&&i.XMLHttpRequest||r.XMLHttpRequest;return function(){var l=Object.create(r,{fetch:{value:void 0,writable:!0}});return function(u,f){f(e)}(this,function(u){var f=typeof l!="undefined"&&l||typeof self!="undefined"&&self||typeof f!="undefined"&&f,h={searchParams:"URLSearchParams"in f,iterable:"Symbol"in f&&"iterator"in Symbol,blob:"FileReader"in f&&"Blob"in f&&function(){try{return new Blob,!0}catch{return!1}}(),formData:"FormData"in f,arrayBuffer:"ArrayBuffer"in f};function y(v){return v&&DataView.prototype.isPrototypeOf(v)}if(h.arrayBuffer)var a=["[object Int8Array]","[object Uint8Array]","[object Uint8ClampedArray]","[object Int16Array]","[object Uint16Array]","[object Int32Array]","[object Uint32Array]","[object Float32Array]","[object Float64Array]"],c=ArrayBuffer.isView||function(v){return v&&a.indexOf(Object.prototype.toString.call(v))>-1};function d(v){if(typeof v!="string"&&(v=String(v)),/[^a-z0-9\-#$%&'*+.^_`|~!]/i.test(v)||v==="")throw new TypeError("Invalid character in header field name");return v.toLowerCase()}function p(v){return typeof v!="string"&&(v=String(v)),v}function E(v){var g={next:function(){var A=v.shift();return{done:A===void 0,value:A}}};return h.iterable&&(g[Symbol.iterator]=function(){return g}),g}function m(v){this.map={},v instanceof m?v.forEach(function(g,A){this.append(A,g)},this):Array.isArray(v)?v.forEach(function(g){this.append(g[0],g[1])},this):v&&Object.getOwnPropertyNames(v).forEach(function(g){this.append(g,v[g])},this)}m.prototype.append=function(v,g){v=d(v),g=p(g);var A=this.map[v];this.map[v]=A?A+", "+g:g},m.prototype.delete=function(v){delete this.map[d(v)]},m.prototype.get=function(v){return v=d(v),this.has(v)?this.map[v]:null},m.prototype.has=function(v){return this.map.hasOwnProperty(d(v))},m.prototype.set=function(v,g){this.map[d(v)]=p(g)},m.prototype.forEach=function(v,g){for(var A in this.map)this.map.hasOwnProperty(A)&&v.call(g,this.map[A],A,this)},m.prototype.keys=function(){var v=[];return this.forEach(function(g,A){v.push(A)}),E(v)},m.prototype.values=function(){var v=[];return this.forEach(function(g){v.push(g)}),E(v)},m.prototype.entries=function(){var v=[];return this.forEach(function(g,A){v.push([A,g])}),E(v)},h.iterable&&(m.prototype[Symbol.iterator]=m.prototype.entries);function S(v){if(v.bodyUsed)return s.reject(new TypeError("Already read"));v.bodyUsed=!0}function R(v){return new s(function(g,A){v.onload=function(){g(v.result)},v.onerror=function(){A(v.error)}})}function b(v){var g=new FileReader,A=R(g);return g.readAsArrayBuffer(v),A}function j(v){var g=new FileReader,A=R(g);return g.readAsText(v),A}function C(v){for(var g=new Uint8Array(v),A=new Array(g.length),V=0;V<g.length;V++)A[V]=String.fromCharCode(g[V]);return A.join("")}function k(v){if(v.slice)return v.slice(0);var g=new Uint8Array(v.byteLength);return g.set(new Uint8Array(v)),g.buffer}function M(){return this.bodyUsed=!1,this._initBody=function(v){this.bodyUsed=this.bodyUsed,this._bodyInit=v,v?typeof v=="string"?this._bodyText=v:h.blob&&Blob.prototype.isPrototypeOf(v)?this._bodyBlob=v:h.formData&&FormData.prototype.isPrototypeOf(v)?this._bodyFormData=v:h.searchParams&&URLSearchParams.prototype.isPrototypeOf(v)?this._bodyText=v.toString():h.arrayBuffer&&h.blob&&y(v)?(this._bodyArrayBuffer=k(v.buffer),this._bodyInit=new Blob([this._bodyArrayBuffer])):h.arrayBuffer&&(ArrayBuffer.prototype.isPrototypeOf(v)||c(v))?this._bodyArrayBuffer=k(v):this._bodyText=v=Object.prototype.toString.call(v):this._bodyText="",this.headers.get("content-type")||(typeof v=="string"?this.headers.set("content-type","text/plain;charset=UTF-8"):this._bodyBlob&&this._bodyBlob.type?this.headers.set("content-type",this._bodyBlob.type):h.searchParams&&URLSearchParams.prototype.isPrototypeOf(v)&&this.headers.set("content-type","application/x-www-form-urlencoded;charset=UTF-8"))},h.blob&&(this.blob=function(){var v=S(this);if(v)return v;if(this._bodyBlob)return s.resolve(this._bodyBlob);if(this._bodyArrayBuffer)return s.resolve(new Blob([this._bodyArrayBuffer]));if(this._bodyFormData)throw new Error("could not read FormData body as blob");return s.resolve(new Blob([this._bodyText]))},this.arrayBuffer=function(){if(this._bodyArrayBuffer){var v=S(this);return v||(ArrayBuffer.isView(this._bodyArrayBuffer)?s.resolve(this._bodyArrayBuffer.buffer.slice(this._bodyArrayBuffer.byteOffset,this._bodyArrayBuffer.byteOffset+this._bodyArrayBuffer.byteLength)):s.resolve(this._bodyArrayBuffer))}else return this.blob().then(b)}),this.text=function(){var v=S(this);if(v)return v;if(this._bodyBlob)return j(this._bodyBlob);if(this._bodyArrayBuffer)return s.resolve(C(this._bodyArrayBuffer));if(this._bodyFormData)throw new Error("could not read FormData body as text");return s.resolve(this._bodyText)},h.formData&&(this.formData=function(){return this.text().then(K)}),this.json=function(){return this.text().then(JSON.parse)},this}var O=["DELETE","GET","HEAD","OPTIONS","POST","PUT"];function $(v){var g=v.toUpperCase();return O.indexOf(g)>-1?g:v}function _(v,g){if(!(this instanceof _))throw new TypeError('Please use the "new" operator, this DOM object constructor cannot be called as a function.');g=g||{};var A=g.body;if(v instanceof _){if(v.bodyUsed)throw new TypeError("Already read");this.url=v.url,this.credentials=v.credentials,g.headers||(this.headers=new m(v.headers)),this.method=v.method,this.mode=v.mode,this.signal=v.signal,!A&&v._bodyInit!=null&&(A=v._bodyInit,v.bodyUsed=!0)}else this.url=String(v);if(this.credentials=g.credentials||this.credentials||"same-origin",(g.headers||!this.headers)&&(this.headers=new m(g.headers)),this.method=$(g.method||this.method||"GET"),this.mode=g.mode||this.mode||null,this.signal=g.signal||this.signal,this.referrer=null,(this.method==="GET"||this.method==="HEAD")&&A)throw new TypeError("Body not allowed for GET or HEAD requests");if(this._initBody(A),(this.method==="GET"||this.method==="HEAD")&&(g.cache==="no-store"||g.cache==="no-cache")){var V=/([?&])_=[^&]*/;if(V.test(this.url))this.url=this.url.replace(V,"$1_="+new Date().getTime());else{var P=/\?/;this.url+=(P.test(this.url)?"&":"?")+"_="+new Date().getTime()}}}_.prototype.clone=function(){return new _(this,{body:this._bodyInit})};function K(v){var g=new FormData;return v.trim().split("&").forEach(function(A){if(A){var V=A.split("="),P=V.shift().replace(/\+/g," "),U=V.join("=").replace(/\+/g," ");g.append(decodeURIComponent(P),decodeURIComponent(U))}}),g}function Y(v){var g=new m,A=v.replace(/\r?\n[\t ]+/g," ");return A.split("\r").map(function(V){return V.indexOf(`
`)===0?V.substr(1,V.length):V}).forEach(function(V){var P=V.split(":"),U=P.shift().trim();if(U){var Ie=P.join(":").trim();g.append(U,Ie)}}),g}M.call(_.prototype);function F(v,g){if(!(this instanceof F))throw new TypeError('Please use the "new" operator, this DOM object constructor cannot be called as a function.');g||(g={}),this.type="default",this.status=g.status===void 0?200:g.status,this.ok=this.status>=200&&this.status<300,this.statusText="statusText"in g?g.statusText:"",this.headers=new m(g.headers),this.url=g.url||"",this._initBody(v)}M.call(F.prototype),F.prototype.clone=function(){return new F(this._bodyInit,{status:this.status,statusText:this.statusText,headers:new m(this.headers),url:this.url})},F.error=function(){var v=new F(null,{status:0,statusText:""});return v.type="error",v};var ye=[301,302,303,307,308];F.redirect=function(v,g){if(ye.indexOf(g)===-1)throw new RangeError("Invalid status code");return new F(null,{status:g,headers:{location:v}})},u.DOMException=f.DOMException;try{new u.DOMException}catch{u.DOMException=function(g,A){this.message=g,this.name=A;var V=Error(g);this.stack=V.stack},u.DOMException.prototype=Object.create(Error.prototype),u.DOMException.prototype.constructor=u.DOMException}function me(v,g){return new s(function(A,V){var P=new _(v,g);if(P.signal&&P.signal.aborted)return V(new u.DOMException("Aborted","AbortError"));var U=new o;function Ie(){U.abort()}U.onload=function(){var z={status:U.status,statusText:U.statusText,headers:Y(U.getAllResponseHeaders()||"")};z.url="responseURL"in U?U.responseURL:z.headers.get("X-Request-URL");var ft="response"in U?U.response:U.responseText;setTimeout(function(){A(new F(ft,z))},0)},U.onerror=function(){setTimeout(function(){V(new TypeError("Network request failed"))},0)},U.ontimeout=function(){setTimeout(function(){V(new TypeError("Network request failed"))},0)},U.onabort=function(){setTimeout(function(){V(new u.DOMException("Aborted","AbortError"))},0)};function ne(z){try{return z===""&&f.location.href?f.location.href:z}catch{return z}}U.open(P.method,ne(P.url),!0),P.credentials==="include"?U.withCredentials=!0:P.credentials==="omit"&&(U.withCredentials=!1),"responseType"in U&&(h.blob?U.responseType="blob":h.arrayBuffer&&P.headers.get("Content-Type")&&P.headers.get("Content-Type").indexOf("application/octet-stream")!==-1&&(U.responseType="arraybuffer")),g&&typeof g.headers=="object"&&!(g.headers instanceof m)?Object.getOwnPropertyNames(g.headers).forEach(function(z){U.setRequestHeader(z,p(g.headers[z]))}):P.headers.forEach(function(z,ft){U.setRequestHeader(ft,z)}),P.signal&&(P.signal.addEventListener("abort",Ie),U.onreadystatechange=function(){U.readyState===4&&P.signal.removeEventListener("abort",Ie)}),U.send(typeof P._bodyInit=="undefined"?null:P._bodyInit)})}me.polyfill=!0,f.fetch||(f.fetch=me,f.Headers=m,f.Request=_,f.Response=F),u.Headers=m,u.Request=_,u.Response=F,u.fetch=me,Object.defineProperty(u,"__esModule",{value:!0})}),{fetch:l.fetch,Headers:l.Headers,Request:l.Request,Response:l.Response,DOMException:l.DOMException}}()}t.exports=n})(typeof globalThis!="undefined"?globalThis:typeof self!="undefined"?self:Dt)})(Ct,Ct.exports);var yi=Ct.exports;const mi=pi(yi);let Pr=globalThis.fetch;typeof EdgeRuntime!="string"&&(Pr=mi().fetch);const Nr=async(t,e,{token:r,body:n,extraHeaders:i}={})=>{const s={"Content-Type":"application/json",Accept:"*/*"};r&&(s.Authorization=`Bearer ${r}`);const o={...s,...i},l={method:e,headers:o};n&&(l.body=JSON.stringify(n));try{const u=await Pr(t,l);if(!u.ok){const f=await u.json();return Promise.reject({error:f})}try{return{data:await u.json(),error:null}}catch{return console.warn(`Unexpected response: can't parse the response of the server at ${t}`),{data:"OK",error:null}}}catch{const f={message:"Network Error",status:0,error:"network"};return Promise.reject({error:f})}},te=async(t,e,r,n)=>Nr(t,"POST",{token:r,body:e,extraHeaders:n}),xr=(t,e)=>Nr(t,"GET",{token:e}),ut=(t,e)=>{const r=e&&Object.entries(e).map(([n,i])=>{const s=Array.isArray(i)?i.join(","):typeof i=="object"?JSON.stringify(i):i;return`${n}=${encodeURIComponent(s)}`}).join("&");return r?`${t}?${r}`:t},re=(t,e)=>{if(!(e!=null&&e.redirectTo))return e;const{redirectTo:r,...n}=e;if(!t)return r.startsWith("/")?n:e;const i=new URL(t),s=Object.fromEntries(new URLSearchParams(i.search)),o=new URL(r.startsWith("/")?i.origin+r:r),l=new URLSearchParams(o.search);let u=Object.fromEntries(l);r.startsWith("/")&&(u={...s,...u});let f=i.pathname;return o.pathname.length>1&&(f+=o.pathname.slice(1)),{...n,redirectTo:ut(o.origin+f,u)}};function Fe(t,e){var i;if(!e){if(typeof window=="undefined")return;e=((i=window.location)==null?void 0:i.href)||""}t=t.replace(/[\[\]]/g,"\\$&");const r=new RegExp("[?&#]"+t+"(=([^&#]*)|&|#|$)"),n=r.exec(e);return n?n[2]?decodeURIComponent(n[2].replace(/\+/g," ")):"":null}function Ut(t){var r;if(typeof window=="undefined")return;const e=window==null?void 0:window.location;if(e&&e){const n=new URLSearchParams(e.search),i=new URLSearchParams((r=e.hash)==null?void 0:r.slice(1));n.delete(t),i.delete(t);let s=window.location.pathname;Array.from(n).length&&(s+=`?${n.toString()}`),Array.from(i).length&&(s+=`#${i.toString()}`),window.history.pushState({},"",s)}}const ae=t=>!!t&&typeof t=="string"&&!!String(t).toLowerCase().match(/^(([^<>()[\]\\.,;:\s@"]+(\.[^<>()[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/),lt=t=>!!t&&typeof t=="string"&&t.length>=3,Mt=t=>!!t&&typeof t=="string",Dr=t=>t&&typeof t=="string"&&t.match(/^mfaTotp:[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i),Cr=({backendUrl:t,clientUrl:e,broadcastKey:r,clientStorageType:n="web",clientStorage:i,refreshIntervalTime:s,autoRefreshToken:o=!0,autoSignIn:l=!0})=>{const u=Ir(n,i),f=kr(n,i),h=async(a,c,d,p)=>(await te(`${t}${a}`,c,d,p)).data;let y=null;if(typeof window!="undefined"&&r)try{y=new BroadcastChannel(r)}catch{}return Oe({schema:{context:{},events:{},services:{}},tsTypes:{},context:st,predictableActionArguments:!0,id:"nhost",type:"parallel",states:{authentication:{initial:"starting",on:{SESSION_UPDATE:[{cond:"hasSession",actions:["saveSession","resetTimer","reportTokenChanged"],target:".signedIn"}]},states:{starting:{tags:["loading"],always:{cond:"isSignedIn",target:"signedIn"},invoke:{id:"importRefreshToken",src:"importRefreshToken",onDone:[{cond:"hasSession",actions:["saveSession","reportTokenChanged"],target:"signedIn"},{target:"signedOut"}],onError:[{cond:"shouldRetryImportToken",actions:"incrementTokenImportAttempts",target:"retryTokenImport"},{actions:["saveAuthenticationError"],target:"signedOut"}]}},retryTokenImport:{tags:["loading"],after:{RETRY_IMPORT_TOKEN_DELAY:"starting"}},signedOut:{initial:"noErrors",entry:"reportSignedOut",states:{noErrors:{},success:{},needsSmsOtp:{},needsMfa:{},failed:{},signingOut:{entry:["clearContextExceptTokens"],exit:["destroyAccessToken","destroyRefreshToken","reportTokenChanged"],invoke:{src:"signout",id:"signingOut",onDone:{target:"success"},onError:{target:"failed",actions:["saveAuthenticationError"]}}}},on:{SIGNIN_PASSWORD:"authenticating.password",SIGNIN_ANONYMOUS:"authenticating.anonymous",SIGNIN_SECURITY_KEY_EMAIL:"authenticating.securityKeyEmail",SIGNIN_SECURITY_KEY:"authenticating.securityKey",SIGNIN_MFA_TOTP:"authenticating.mfa.totp",SIGNIN_PAT:"authenticating.pat",SIGNIN_ID_TOKEN:"authenticating.idToken"}},authenticating:{entry:"resetErrors",states:{password:{invoke:{src:"signInPassword",id:"authenticateUserWithPassword",onDone:[{cond:"hasMfaTicket",actions:["saveMfaTicket"],target:"#nhost.authentication.signedOut.needsMfa"},{actions:["saveSession","reportTokenChanged"],target:"#nhost.authentication.signedIn"}],onError:[{cond:"unverified",target:["#nhost.authentication.signedOut","#nhost.registration.incomplete.needsEmailVerification"]},{actions:"saveAuthenticationError",target:"#nhost.authentication.signedOut.failed"}]}},pat:{invoke:{src:"signInPAT",id:"authenticateWithPAT",onDone:{actions:["savePATSession","reportTokenChanged"],target:"#nhost.authentication.signedIn"},onError:{actions:"saveAuthenticationError",target:"#nhost.authentication.signedOut.failed"}}},idToken:{invoke:{src:"signInIdToken",id:"authenticateWithIdToken",onDone:{actions:["saveSession","reportTokenChanged"],target:"#nhost.authentication.signedIn"},onError:{actions:"saveAuthenticationError",target:"#nhost.authentication.signedOut.failed"}}},anonymous:{invoke:{src:"signInAnonymous",id:"authenticateAnonymously",onDone:{actions:["saveSession","reportTokenChanged"],target:"#nhost.authentication.signedIn"},onError:{actions:"saveAuthenticationError",target:"#nhost.authentication.signedOut.failed"}}},mfa:{states:{totp:{invoke:{src:"signInMfaTotp",id:"signInMfaTotp",onDone:{actions:["saveSession","reportTokenChanged"],target:"#nhost.authentication.signedIn"},onError:{actions:["saveAuthenticationError"],target:"#nhost.authentication.signedOut.failed"}}}}},securityKeyEmail:{invoke:{src:"signInSecurityKeyEmail",id:"authenticateUserWithSecurityKey",onDone:{actions:["saveSession","reportTokenChanged"],target:"#nhost.authentication.signedIn"},onError:[{cond:"unverified",target:["#nhost.authentication.signedOut","#nhost.registration.incomplete.needsEmailVerification"]},{actions:"saveAuthenticationError",target:"#nhost.authentication.signedOut.failed"}]}},securityKey:{invoke:{src:"signInSecurityKey",id:"authenticateUserWithSecurityKey",onDone:{actions:["saveSession","reportTokenChanged"],target:"#nhost.authentication.signedIn"},onError:[{cond:"unverified",target:["#nhost.authentication.signedOut","#nhost.registration.incomplete.needsEmailVerification"]},{actions:"saveAuthenticationError",target:"#nhost.authentication.signedOut.failed"}]}}}},signedIn:{type:"parallel",entry:["reportSignedIn","cleanUrl","broadcastToken","resetErrors"],on:{SIGNOUT:"signedOut.signingOut"},states:{refreshTimer:{id:"timer",initial:"idle",states:{disabled:{type:"final"},stopped:{always:{cond:"noToken",target:"idle"}},idle:{always:[{cond:"isAutoRefreshDisabled",target:"disabled"},{cond:"isRefreshTokenPAT",target:"disabled"},{cond:"hasRefreshToken",target:"running"}]},running:{initial:"pending",entry:"resetTimer",states:{pending:{after:{1e3:{internal:!1,target:"pending"}},always:{cond:"refreshTimerShouldRefresh",target:"refreshing"}},refreshing:{invoke:{src:"refreshToken",id:"refreshToken",onDone:{actions:["saveSession","resetTimer","reportTokenChanged","broadcastToken"],target:"pending"},onError:[{cond:"isUnauthorizedError",target:"#nhost.authentication.signedOut"},{actions:"saveRefreshAttempt",target:"pending"}]}}}}}}}}}},token:{initial:"idle",states:{idle:{on:{TRY_TOKEN:"running"},initial:"noErrors",states:{noErrors:{},error:{}}},running:{invoke:{src:"refreshToken",id:"authenticateWithToken",onDone:{actions:["saveSession","reportTokenChanged","broadcastToken"],target:["#nhost.authentication.signedIn","idle.noErrors"]},onError:[{cond:"isSignedIn",target:"idle.error"},{actions:"saveAuthenticationError",target:["#nhost.authentication.signedOut.failed","idle.error"]}]}}}},registration:{initial:"incomplete",on:{SIGNED_IN:[{cond:"isAnonymous",target:".incomplete"},".complete"]},states:{incomplete:{on:{SIGNUP_EMAIL_PASSWORD:"emailPassword",SIGNUP_SECURITY_KEY:"securityKey",PASSWORDLESS_EMAIL:"passwordlessEmail",PASSWORDLESS_SMS:"passwordlessSms",PASSWORDLESS_SMS_OTP:"passwordlessSmsOtp",SIGNIN_EMAIL_OTP:"signInEmailOTP",VERIFY_EMAIL_OTP:"verifyEmailOTP"},initial:"noErrors",states:{noErrors:{},needsEmailVerification:{},needsOtp:{},failed:{}}},emailPassword:{entry:["resetErrors"],invoke:{src:"signUpEmailPassword",id:"signUpEmailPassword",onDone:[{cond:"hasSession",actions:["saveSession","reportTokenChanged"],target:"#nhost.authentication.signedIn"},{actions:"clearContext",target:["#nhost.authentication.signedOut","incomplete.needsEmailVerification"]}],onError:[{cond:"unverified",target:"incomplete.needsEmailVerification"},{actions:"saveRegistrationError",target:"incomplete.failed"}]}},securityKey:{entry:["resetErrors"],invoke:{src:"signUpSecurityKey",id:"signUpSecurityKey",onDone:[{cond:"hasSession",actions:["saveSession","reportTokenChanged"],target:"#nhost.authentication.signedIn"},{actions:"clearContext",target:["#nhost.authentication.signedOut","incomplete.needsEmailVerification"]}],onError:[{cond:"unverified",target:"incomplete.needsEmailVerification"},{actions:"saveRegistrationError",target:"incomplete.failed"}]}},passwordlessEmail:{entry:["resetErrors"],invoke:{src:"passwordlessEmail",id:"passwordlessEmail",onDone:{actions:"clearContext",target:["#nhost.authentication.signedOut","incomplete.needsEmailVerification"]},onError:{actions:"saveRegistrationError",target:"incomplete.failed"}}},passwordlessSms:{entry:["resetErrors"],invoke:{src:"passwordlessSms",id:"passwordlessSms",onDone:{actions:"clearContext",target:["#nhost.authentication.signedOut","incomplete.needsOtp"]},onError:{actions:"saveRegistrationError",target:"incomplete.failed"}}},passwordlessSmsOtp:{entry:["resetErrors"],invoke:{src:"passwordlessSmsOtp",id:"passwordlessSmsOtp",onDone:{actions:["saveSession","reportTokenChanged"],target:"#nhost.authentication.signedIn"},onError:{actions:"saveRegistrationError",target:"incomplete.failed"}}},signInEmailOTP:{entry:["resetErrors"],invoke:{src:"signInEmailOTP",id:"signInEmailOTP",onDone:{actions:"clearContext",target:["#nhost.authentication.signedOut","incomplete.needsOtp"]},onError:{actions:"saveRegistrationError",target:"incomplete.failed"}}},verifyEmailOTP:{entry:["resetErrors"],invoke:{src:"verifyEmailOTP",id:"verifyEmailOTP",onDone:{actions:["saveSession","reportTokenChanged"],target:"#nhost.authentication.signedIn"},onError:{actions:"saveRegistrationError",target:"incomplete.failed"}}},complete:{on:{SIGNED_OUT:"incomplete"}}}}}},{actions:{reportSignedIn:ee("SIGNED_IN"),reportSignedOut:ee("SIGNED_OUT"),reportTokenChanged:ee("TOKEN_CHANGED"),incrementTokenImportAttempts:B({importTokenAttempts:({importTokenAttempts:a})=>a+1}),clearContext:B(()=>(f(he,null),f(ce,null),f(ke,null),{...st})),clearContextExceptTokens:B(({accessToken:a,refreshToken:c})=>({...st,accessToken:a,refreshToken:c})),saveSession:B({user:(a,{data:c})=>{var d;return((d=c==null?void 0:c.session)==null?void 0:d.user)||null},accessToken:(a,{data:c})=>{if(c.session){const{accessTokenExpiresIn:d,accessToken:p}=c.session,E=new Date(Date.now()+d*1e3);return f(he,E.toISOString()),{value:p,expiresAt:E,expiresInSeconds:d}}return f(he,null),{value:null,expiresAt:null,expiresInSeconds:null}},refreshToken:(a,{data:c})=>{var E,m;const d=((E=c.session)==null?void 0:E.refreshToken)||null,p=((m=c.session)==null?void 0:m.refreshTokenId)||null;return d&&f(ce,d),p&&f(ke,p),{value:d}}}),savePATSession:B({user:(a,{data:c})=>{var d;return((d=c==null?void 0:c.session)==null?void 0:d.user)||null},accessToken:(a,{data:c})=>{if(c.session){const{accessTokenExpiresIn:d,accessToken:p}=c.session,E=new Date(Date.now()+d*1e3);return f(he,E.toISOString()),{value:p,expiresAt:E,expiresInSeconds:d}}return f(he,null),{value:null,expiresAt:null,expiresInSeconds:null}},refreshToken:(a,{data:c})=>{var E,m;const d=((E=c.session)==null?void 0:E.refreshToken)||null,p=((m=c.session)==null?void 0:m.refreshTokenId)||null;return d&&f(ce,d),p&&f(ke,p),{value:d,isPAT:!0}}}),saveMfaTicket:B({mfa:(a,c)=>{var d;return(d=c.data)==null?void 0:d.mfa}}),resetTimer:B({refreshTimer:a=>({startedAt:new Date,attempts:0,lastAttempt:null})}),saveRefreshAttempt:B({refreshTimer:(a,c)=>({startedAt:a.refreshTimer.startedAt,attempts:a.refreshTimer.attempts+1,lastAttempt:new Date})}),saveAuthenticationError:B({errors:({errors:a},{data:{error:c}})=>({...a,authentication:c})}),resetErrors:B({errors:a=>({}),importTokenAttempts:a=>0}),saveRegistrationError:B({errors:({errors:a},{data:{error:c}})=>({...a,registration:c})}),destroyRefreshToken:B({refreshToken:a=>(f(ce,null),f(ke,null),{value:null})}),destroyAccessToken:B({accessToken:a=>(f(he,null),{value:null,expiresAt:null,expiresInSeconds:null})}),cleanUrl:()=>{l&&Fe("refreshToken")&&(Ut("refreshToken"),Ut("type"))},broadcastToken:a=>{if(l&&r&&y)try{y.postMessage({type:"broadcast_session",payload:{token:a.refreshToken.value,accessToken:a.accessToken.value,user:a.user,expiresAt:a.accessToken.expiresAt?a.accessToken.expiresAt.toISOString():null,expiresInSeconds:a.accessToken.expiresInSeconds}})}catch{}}},guards:{isAnonymous:(a,c)=>{var d;return!!((d=a.user)!=null&&d.isAnonymous)},isSignedIn:a=>!!a.user&&!!a.accessToken.value,noToken:a=>!a.refreshToken.value,isRefreshTokenPAT:a=>{var c;return!!((c=a.refreshToken)!=null&&c.isPAT)},hasRefreshToken:a=>!!a.refreshToken.value,isAutoRefreshDisabled:()=>!o,refreshTimerShouldRefresh:a=>{const{expiresAt:c}=a.accessToken;if(!c)return!1;if(a.refreshTimer.lastAttempt)return a.refreshTimer.attempts>5?!1:Date.now()-a.refreshTimer.lastAttempt.getTime()>Math.pow(2,a.refreshTimer.attempts-1)*5e3;if(c.getTime()<Date.now()||s&&Date.now()-a.refreshTimer.startedAt.getTime()>s*1e3)return!0;if(!a.accessToken.expiresInSeconds)return!1;const p=c.getTime()-Date.now();return p<=60*1e3/2||p<=60*1e3&&Math.random()<.1},shouldRetryImportToken:(a,c)=>a.importTokenAttempts<5&&(c.data.error.status===0||c.data.error.status>=500),unverified:(a,{data:{error:c}})=>c.status===401&&(c.message==="Email is not verified"||c.error==="unverified-user"),hasSession:(a,c)=>{var d;return!!((d=c.data)!=null&&d.session)},hasMfaTicket:(a,c)=>{var d;return!!((d=c.data)!=null&&d.mfa)},isUnauthorizedError:(a,{data:{error:c}})=>c.status===401},services:{signInPassword:(a,{email:c,password:d})=>ae(c)?lt(d)?h("/signin/email-password",{email:c,password:d}):Promise.reject({error:He}):Promise.reject({error:se}),signInPAT:(a,{pat:c})=>h("/signin/pat",{personalAccessToken:c}),signInIdToken:(a,{provider:c,idToken:d,nonce:p})=>h("/signin/idtoken",{provider:c,idToken:d,...p&&{nonce:p}}),passwordlessSms:(a,{phoneNumber:c,options:d})=>{var p;return Mt(c)?(p=a.user)!=null&&p.isAnonymous?(console.warn("Deanonymisation from a phone number is not yet implemented in hasura-auth"),h("/user/deanonymize",{signInMethod:"passwordless",connection:"sms",phoneNumber:c,options:re(e,d)},a.accessToken.value)):h("/signin/passwordless/sms",{phoneNumber:c,options:re(e,d)}):Promise.reject({error:dt})},passwordlessSmsOtp:(a,{phoneNumber:c,otp:d})=>Mt(c)?h("/signin/passwordless/sms/otp",{phoneNumber:c,otp:d}):Promise.reject({error:dt}),signInEmailOTP:(a,{email:c,options:d})=>ae(c)?h("/signin/otp/email",{email:c,options:re(e,d)}):Promise.reject({error:se}),verifyEmailOTP:(a,{email:c,otp:d})=>ae(c)?h("/signin/otp/email/verify",{email:c,otp:d}):Promise.reject({error:se}),passwordlessEmail:(a,{email:c,options:d})=>{var p;return ae(c)?(p=a.user)!=null&&p.isAnonymous?h("/user/deanonymize",{signInMethod:"passwordless",connection:"email",email:c,options:re(e,d)},a.accessToken.value):h("/signin/passwordless/email",{email:c,options:re(e,d)}):Promise.reject({error:se})},signInAnonymous:a=>h("/signin/anonymous"),signInMfaTotp:(a,c)=>{var p;const d=c.ticket||((p=a.mfa)==null?void 0:p.ticket);return d?Dr(d)?h("/signin/mfa/totp",{ticket:d,otp:c.otp}):Promise.reject({error:Ft}):Promise.reject({error:Ht})},signInSecurityKeyEmail:async(a,{email:c})=>{if(!ae(c))throw new ve(se);const d=await h("/signin/webauthn",{email:c});let p;try{p=await Pt(d)}catch(E){throw new ve(E)}return h("/signin/webauthn/verify",{email:c,credential:p})},refreshToken:async(a,c)=>{const d=c.type==="TRY_TOKEN"?c.token:a.refreshToken.value;return{session:await h("/token",{refreshToken:d}),error:null}},signInSecurityKey:async()=>{try{const a=await h("/signin/webauthn",{});let c;try{c=await Pt(a)}catch(d){throw new ve(d)}return h("/signin/webauthn/verify",{credential:c})}catch(a){throw new ve(a)}},signout:async(a,c)=>{const d=await h("/signout",{refreshToken:a.refreshToken.value,all:!!c.all},c.all?a.accessToken.value:void 0);if(r&&y)try{y.postMessage({type:"signout"})}catch{}return d},signUpEmailPassword:async(a,{email:c,password:d,options:p,requestOptions:E})=>{var m;return ae(c)?lt(d)?(m=a.user)!=null&&m.isAnonymous?h("/user/deanonymize",{signInMethod:"email-password",email:c,password:d,options:re(e,p)},a.accessToken.value,E==null?void 0:E.headers):h("/signup/email-password",{email:c,password:d,options:re(e,p)},null,E==null?void 0:E.headers):Promise.reject({error:He}):Promise.reject({error:se})},signUpSecurityKey:async(a,{email:c,options:d,requestOptions:p})=>{if(!ae(c))return Promise.reject({error:se});const E=d==null?void 0:d.nickname;E&&delete d.nickname;const m=await h("/signup/webauthn",{email:c,options:d},null,p==null?void 0:p.headers);let S;try{S=await Or(m)}catch(R){throw new ve(R)}return h("/signup/webauthn/verify",{credential:S,options:{redirectTo:d==null?void 0:d.redirectTo,nickname:E,displayName:d==null?void 0:d.displayName,...(d==null?void 0:d.metadata)&&{metadata:d==null?void 0:d.metadata}}})},importRefreshToken:async a=>{if(a.user&&a.refreshToken.value&&a.accessToken.value&&a.accessToken.expiresAt)return{session:{accessToken:a.accessToken.value,accessTokenExpiresIn:a.accessToken.expiresAt.getTime()-Date.now(),refreshToken:a.refreshToken.value,user:a.user},error:null};let c=null;if(l){const p=Fe("refreshToken")||null;if(p)try{return{session:await h("/token",{refreshToken:p}),error:null}}catch(E){c=E.error}else{const E=Fe("error"),m=Fe("errorDescription");if(E&&m!=="social user already exists")return Promise.reject({session:null,error:{status:10,error:E,message:m||E}})}}const d=await u(ce);if(d)try{return{session:await h("/token",{refreshToken:d}),error:null}}catch(p){c=p.error}return c?Promise.reject({error:c,session:null}):{error:null,session:null}}},delays:{RETRY_IMPORT_TOKEN_DELAY:({importTokenAttempts:a})=>Math.pow(2,a-1)*5e3}})},Ur=({backendUrl:t,clientUrl:e,interpreter:r})=>Oe({schema:{context:{},events:{},services:{}},tsTypes:{},predictableActionArguments:!0,id:"changeEmail",initial:"idle",context:{error:null},states:{idle:{on:{REQUEST:[{cond:"invalidEmail",actions:"saveInvalidEmailError",target:".error"},{target:"requesting"}]},initial:"initial",states:{initial:{},success:{},error:{}}},requesting:{invoke:{src:"requestChange",id:"requestChange",onDone:{target:"idle.success",actions:"reportSuccess"},onError:{actions:["saveRequestError","reportError"],target:"idle.error"}}}}},{actions:{saveInvalidEmailError:B({error:n=>se}),saveRequestError:B({error:(n,{data:{error:i}})=>i}),reportError:ee(n=>({type:"ERROR",error:n.error})),reportSuccess:ee("SUCCESS")},guards:{invalidEmail:(n,{email:i})=>!ae(i)},services:{requestChange:async(n,{email:i,options:s})=>(await te(`${t}/user/email/change`,{newEmail:i,options:re(e,s)},r==null?void 0:r.getSnapshot().context.accessToken.value)).data}}),Mr=({backendUrl:t,interpreter:e})=>Oe({schema:{context:{},events:{},services:{}},tsTypes:{},predictableActionArguments:!0,id:"changePassword",initial:"idle",context:{error:null},states:{idle:{on:{REQUEST:[{cond:"invalidPassword",actions:"saveInvalidPasswordError",target:".error"},{target:"requesting"}]},initial:"initial",states:{initial:{},success:{},error:{}}},requesting:{invoke:{src:"requestChange",id:"requestChange",onDone:{target:"idle.success",actions:"reportSuccess"},onError:{actions:["saveRequestError","reportError"],target:"idle.error"}}}}},{actions:{saveInvalidPasswordError:B({error:r=>He}),saveRequestError:B({error:(r,{data:{error:n}})=>n}),reportError:ee(r=>({type:"ERROR",error:r.error})),reportSuccess:ee("SUCCESS")},guards:{invalidPassword:(r,{password:n})=>!lt(n)},services:{requestChange:(r,{password:n,ticket:i})=>te(`${t}/user/password`,{newPassword:n,ticket:i},e==null?void 0:e.getSnapshot().context.accessToken.value)}}),gi=({backendUrl:t,interpreter:e})=>Oe({schema:{context:{},events:{}},tsTypes:{},predictableActionArguments:!0,id:"enableMfa",initial:"idle",context:{error:null,imageUrl:null,secret:null},states:{idle:{initial:"initial",on:{GENERATE:"generating",DISABLE:"disabling"},states:{initial:{},error:{},disabled:{}}},generating:{invoke:{src:"generate",id:"generate",onDone:{target:"generated",actions:["reportGeneratedSuccess","saveGeneration"]},onError:{actions:["saveError","reportGeneratedError"],target:"idle.error"}}},generated:{initial:"idle",states:{idle:{initial:"idle",on:{ACTIVATE:[{cond:"invalidMfaType",actions:"saveInvalidMfaTypeError",target:".error"},{cond:"invalidMfaCode",actions:"saveInvalidMfaCodeError",target:".error"},{target:"activating"}],DISABLE:"#enableMfa.disabling"},states:{idle:{},error:{}}},activating:{invoke:{src:"activate",id:"activate",onDone:{target:"activated",actions:"reportSuccess"},onError:{actions:["saveError","reportError"],target:"idle.error"}}},activated:{type:"final"}}},disabling:{invoke:{src:"disable",id:"disable",onDone:{target:"idle.disabled",actions:"reportSuccess"},onError:{actions:["saveError","reportError"],target:"idle.error"}}}}},{actions:{saveInvalidMfaTypeError:B({error:r=>Gt}),saveInvalidMfaCodeError:B({error:r=>Bt}),saveError:B({error:(r,{data:{error:n}})=>n}),saveGeneration:B({imageUrl:(r,{data:{imageUrl:n}})=>n,secret:(r,{data:{totpSecret:n}})=>n}),reportError:ee((r,n)=>({type:"ERROR",error:r.error})),reportSuccess:ee("SUCCESS"),reportGeneratedSuccess:ee("GENERATED"),reportGeneratedError:ee(r=>({type:"GENERATED_ERROR",error:r.error}))},guards:{invalidMfaCode:(r,{code:n})=>!n,invalidMfaType:(r,{activeMfaType:n})=>!n||n!=="totp"},services:{generate:async r=>{const{data:n}=await xr(`${t}/mfa/totp/generate`,e==null?void 0:e.getSnapshot().context.accessToken.value);return n},activate:(r,{code:n,activeMfaType:i})=>te(`${t}/user/mfa`,{code:n,activeMfaType:i},e==null?void 0:e.getSnapshot().context.accessToken.value),disable:(r,{code:n})=>te(`${t}/user/mfa`,{code:n,activeMfaType:""},e==null?void 0:e.getSnapshot().context.accessToken.value)}}),Lr=({backendUrl:t,clientUrl:e})=>Oe({schema:{context:{},events:{},services:{}},tsTypes:{},predictableActionArguments:!0,id:"changePassword",initial:"idle",context:{error:null},states:{idle:{on:{REQUEST:[{cond:"invalidEmail",actions:"saveInvalidEmailError",target:".error"},{target:"requesting"}]},initial:"initial",states:{initial:{},success:{},error:{}}},requesting:{invoke:{src:"requestChange",id:"requestChange",onDone:{target:"idle.success",actions:"reportSuccess"},onError:{actions:["saveRequestError","reportError"],target:"idle.error"}}}}},{actions:{saveInvalidEmailError:B({error:r=>se}),saveRequestError:B({error:(r,{data:{error:n}})=>n}),reportError:ee(r=>({type:"ERROR",error:r.error})),reportSuccess:ee("SUCCESS")},guards:{invalidEmail:(r,{email:n})=>!ae(n)},services:{requestChange:(r,{email:n,options:i})=>te(`${t}/user/password/reset`,{email:n,options:re(e,i)})}}),jr=({backendUrl:t,clientUrl:e})=>Oe({schema:{context:{},events:{},services:{}},tsTypes:{},predictableActionArguments:!0,id:"sendVerificationEmail",initial:"idle",context:{error:null},states:{idle:{on:{REQUEST:[{cond:"invalidEmail",actions:"saveInvalidEmailError",target:".error"},{target:"requesting"}]},initial:"initial",states:{initial:{},success:{},error:{}}},requesting:{invoke:{src:"request",id:"request",onDone:{target:"idle.success",actions:"reportSuccess"},onError:{actions:["saveRequestError","reportError"],target:"idle.error"}}}}},{actions:{saveInvalidEmailError:B({error:r=>se}),saveRequestError:B({error:(r,{data:{error:n}})=>n}),reportError:ee(r=>({type:"ERROR",error:r.error})),reportSuccess:ee("SUCCESS")},guards:{invalidEmail:(r,{email:n})=>!ae(n)},services:{request:async(r,{email:n,options:i})=>(await te(`${t}/user/email/send-verification-email`,{email:n,options:re(e,i)})).data}});class Lt{constructor({clientStorageType:e="web",autoSignIn:r=!0,autoRefreshToken:n=!0,start:i=!0,backendUrl:s,clientUrl:o,broadcastKey:l,devTools:u,...f}){var h;if(this._started=!1,this._subscriptionsQueue=new Set,this._subscriptions=new Set,this.backendUrl=s,this.clientUrl=o,this._machine=Cr({...f,backendUrl:s,clientUrl:o,broadcastKey:l,clientStorageType:e,autoSignIn:r,autoRefreshToken:n}),i&&this.start({devTools:u}),typeof window!="undefined"&&l)try{this._channel=new BroadcastChannel(l),r&&((h=this._channel)==null||h.addEventListener("message",y=>{var d;const{type:a,payload:c}=y.data;if(a==="broadcast_session"){const p=(d=this.interpreter)==null?void 0:d.getSnapshot().context,E=p==null?void 0:p.refreshToken.value;this.interpreter&&c.token&&c.token!==E&&this.interpreter.send("SESSION_UPDATE",{data:{session:{user:c.user,accessToken:c.accessToken,refreshToken:c.token,accessTokenExpiresIn:c.expiresInSeconds}}})}})),this._channel.addEventListener("message",y=>{const{type:a}=y.data;a==="signout"&&this.interpreter&&this.interpreter.send("SIGNOUT")})}catch{}}start({devTools:e=!1,initialSession:r,interpreter:n}={}){var o,l;const i={...this.machine.context,accessToken:{...this.machine.context.accessToken},refreshToken:{...this.machine.context.refreshToken}};r&&(i.user=r.user,i.refreshToken.value=(o=r.refreshToken)!=null?o:null,i.accessToken.value=(l=r.accessToken)!=null?l:null,i.accessToken.expiresAt=new Date(Date.now()+r.accessTokenExpiresIn*1e3));const s=this.machine.withContext(i);this._interpreter||(this._interpreter=n||Re(s,{devTools:e})),(!this._started||typeof window=="undefined")&&(this._interpreter.initialized&&(this._interpreter.stop(),this._subscriptions.forEach(u=>u())),this._interpreter.start(s.initialState),this._subscriptionsQueue.forEach(u=>u(this))),this._started=!0}get machine(){return this._machine}get interpreter(){return this._interpreter}get started(){return this._started}subscribe(e){if(this.started){const r=e(this);return this._subscriptions.add(r),r}else return this._subscriptionsQueue.add(e),()=>{console.log("onTokenChanged was added before the interpreter started. Cannot unsubscribe listener.")}}}class Kr extends Lt{constructor({...e}){super({...e,autoSignIn:Be()&&e.autoSignIn,autoRefreshToken:Be()&&e.autoRefreshToken,clientStorageType:"cookie"})}}const Ei=Kr,Vr=async({backendUrl:t,interpreter:e},r)=>{try{const{data:n}=await te(`${t}/user/webauthn/add`,{},e==null?void 0:e.getSnapshot().context.accessToken.value);let i;try{i=await Or(n)}catch(o){throw new ve(o)}const{data:s}=await te(`${t}/user/webauthn/verify`,{credential:i,nickname:r},e==null?void 0:e.getSnapshot().context.accessToken.value);return{key:s,isError:!1,error:null,isSuccess:!0}}catch(n){const{error:i}=n;return{isError:!0,error:i,isSuccess:!1}}},Gr=async(t,e,r)=>new Promise(n=>{t.send("REQUEST",{email:e,options:r}),t.onTransition(i=>{i.matches({idle:"error"})?n({error:i.context.error,isError:!0,needsEmailVerification:!1}):i.matches({idle:"success"})&&n({error:null,isError:!1,needsEmailVerification:!0})})}),Br=async(t,e,r)=>new Promise(n=>{t.send("REQUEST",{password:e,ticket:r}),t.onTransition(i=>{i.matches({idle:"error"})?n({error:i.context.error,isError:!0,isSuccess:!1}):i.matches({idle:"success"})&&n({error:null,isError:!1,isSuccess:!0})})}),Ti=t=>new Promise(e=>{t.send("GENERATE"),t.onTransition(r=>{r.matches("generated")?e({error:null,isError:!1,isGenerated:!0,qrCodeDataUrl:r.context.imageUrl||"",totpSecret:r.context.secret}):r.matches({idle:"error"})&&e({error:r.context.error||null,isError:!0,isGenerated:!1,qrCodeDataUrl:"",totpSecret:r.context.secret})})}),wi=(t,e)=>new Promise(r=>{t.send("ACTIVATE",{activeMfaType:"totp",code:e}),t.onTransition(n=>{n.matches({generated:"activated"})?r({error:null,isActivated:!0,isError:!1}):n.matches({generated:{idle:"error"}})&&r({error:n.context.error,isActivated:!1,isError:!0})})}),Si=(t,e)=>new Promise(r=>{t.send("DISABLE",{code:e}),t.onTransition(n=>{n.matches({idle:"disabled"})?r({error:null,isDisabled:!0,isError:!1}):n.matches({idle:"error"})&&r({error:n.context.error,isDisabled:!1,isError:!0})})}),Fr=async(t,e,r)=>new Promise(n=>{t.send("REQUEST",{email:e,options:r}),t.onTransition(i=>{i.matches({idle:"error"})?n({error:i.context.error,isError:!0,isSent:!1}):i.matches({idle:"success"})&&n({error:null,isError:!1,isSent:!0})})}),Hr=(t,e,r)=>new Promise(n=>{t.send("REQUEST",{email:e,options:r}),t.onTransition(i=>{i.matches({idle:"error"})?n({error:i.context.error,isError:!0,isSent:!1}):i.matches({idle:"success"})&&n({error:null,isError:!1,isSent:!0})})}),$r=t=>new Promise(e=>{const{changed:r}=t.send("SIGNIN_ANONYMOUS");r||e({isSuccess:!1,isError:!0,error:Z,user:null,accessToken:null,refreshToken:null}),t.onTransition(n=>{n.matches({authentication:"signedIn"})&&e({isSuccess:!0,isError:!1,error:null,user:n.context.user,accessToken:n.context.accessToken.value,refreshToken:n.context.refreshToken.value}),n.matches({authentication:{signedOut:"failed"}})&&e({isSuccess:!1,isError:!0,error:n.context.errors.authentication||null,user:null,accessToken:null,refreshToken:null})})}),Wr=(t,e,r)=>new Promise(n=>{const{changed:i,context:s}=t.send("SIGNIN_PASSWORD",{email:e,password:r});if(!i)return n({accessToken:s.accessToken.value,refreshToken:s.refreshToken.value,error:Z,isError:!0,isSuccess:!1,needsEmailVerification:!1,needsMfaOtp:!1,mfa:null,user:s.user});t.onTransition(o=>{o.matches({authentication:{signedOut:"noErrors"},registration:{incomplete:"needsEmailVerification"}})?n({accessToken:null,refreshToken:null,error:null,isError:!1,isSuccess:!1,needsEmailVerification:!0,needsMfaOtp:!1,mfa:null,user:null}):o.matches({authentication:{signedOut:"needsMfa"}})?n({accessToken:null,refreshToken:null,error:null,isError:!1,isSuccess:!1,needsEmailVerification:!1,needsMfaOtp:!0,mfa:o.context.mfa,user:null}):o.matches({authentication:{signedOut:"failed"}})?n({accessToken:null,refreshToken:null,error:o.context.errors.authentication||null,isError:!0,isSuccess:!1,needsEmailVerification:!1,needsMfaOtp:!1,mfa:null,user:null}):o.matches({authentication:"signedIn"})&&n({accessToken:o.context.accessToken.value,refreshToken:o.context.refreshToken.value,error:null,isError:!1,isSuccess:!0,needsEmailVerification:!1,needsMfaOtp:!1,mfa:null,user:o.context.user})})}),jt=(t,e,r)=>new Promise(n=>{const{changed:i}=t.send("PASSWORDLESS_EMAIL",{email:e,options:r});if(!i)return n({error:Z,isError:!0,isSuccess:!1});t.onTransition(s=>{s.matches("registration.incomplete.failed")?n({error:s.context.errors.registration||null,isError:!0,isSuccess:!1}):s.matches({authentication:{signedOut:"noErrors"},registration:{incomplete:"needsEmailVerification"}})&&n({error:null,isError:!1,isSuccess:!0})})}),Yr=(t,e)=>new Promise(r=>{const{changed:n,context:i}=t.send({type:"SIGNIN_SECURITY_KEY_EMAIL",email:e});if(!n)return r({accessToken:i.accessToken.value,refreshToken:i.refreshToken.value,error:Z,isError:!0,isSuccess:!1,needsEmailVerification:!1,user:i.user});t.onTransition(s=>{s.matches({authentication:{signedOut:"noErrors"},registration:{incomplete:"needsEmailVerification"}})?r({accessToken:null,refreshToken:null,error:null,isError:!1,isSuccess:!1,needsEmailVerification:!0,user:null}):s.matches({authentication:{signedOut:"failed"}})?r({accessToken:null,refreshToken:null,error:s.context.errors.authentication||null,isError:!0,isSuccess:!1,needsEmailVerification:!1,user:null}):s.matches({authentication:"signedIn"})&&r({accessToken:s.context.accessToken.value,refreshToken:s.context.refreshToken.value,error:null,isError:!1,isSuccess:!0,needsEmailVerification:!1,user:s.context.user})})});function qr(t){return{error:t.message||"Something went wrong!",status:t.status||1,message:t.message||"Something went wrong!"}}const zr=async(t,e)=>{var o,l;const r=(o=t.interpreter)==null?void 0:o.getSnapshot(),n=r==null?void 0:r.context.accessToken.value;let i;try{i=(await te(`${t.backendUrl}/elevate/webauthn`,{email:e},n)).data}catch(u){return{error:qr(u),isError:!0,isSuccess:!1,elevated:!1}}let s;try{s=await Pt(i)}catch(u){return{error:qr(u),isError:!0,isSuccess:!1,elevated:!1}}try{const{data:{session:u},error:f}=await te(`${t.backendUrl}/elevate/webauthn/verify`,{email:e,credential:s},n);return u&&!f?((l=t.interpreter)==null||l.send({type:"SESSION_UPDATE",data:{session:u}}),{error:null,isError:!1,isSuccess:!0,elevated:!0}):{error:f,isError:!0,isSuccess:!1,elevated:!1}}catch(u){const{error:f}=u;return{error:f,isError:!0,isSuccess:!1,elevated:!1}}},Xr=(t,e,r)=>new Promise(n=>{const{changed:i,context:s}=t.send("SIGNIN_MFA_TOTP",{otp:e,ticket:r});if(!i)return n({accessToken:s.accessToken.value,refreshToken:s.refreshToken.value,error:Z,isError:!0,isSuccess:!1,user:s.user});t.onTransition(o=>{o.matches({authentication:{signedOut:"failed"}})?n({accessToken:null,refreshToken:null,error:o.context.errors.authentication||null,isError:!0,isSuccess:!1,user:null}):o.matches({authentication:"signedIn"})&&n({accessToken:o.context.accessToken.value,refreshToken:o.context.refreshToken.value,error:null,isError:!1,isSuccess:!0,user:o.context.user})})}),Qr=(t,e)=>new Promise(r=>{const{changed:n}=t.send("SIGNIN_PAT",{pat:e});n||r({isSuccess:!1,isError:!0,error:Z,user:null,accessToken:null,refreshToken:null}),t.onTransition(i=>{if(i.matches({authentication:{signedOut:"failed"}}))return r({accessToken:null,refreshToken:null,user:null,error:i.context.errors.authentication||null,isError:!0,isSuccess:!1});if(i.matches({authentication:"signedIn"}))return r({accessToken:i.context.accessToken.value,refreshToken:i.context.refreshToken.value,user:i.context.user,error:null,isError:!1,isSuccess:!0})})}),Kt=(t,e,r)=>new Promise(n=>{const{changed:i}=t.send("PASSWORDLESS_SMS",{phoneNumber:e,options:r});if(!i)return n({error:Z,isError:!0,isSuccess:!1,needsOtp:!1});t.onTransition(s=>{s.matches("registration.incomplete.needsOtp")?n({error:null,isError:!1,isSuccess:!1,needsOtp:!0}):s.matches("registration.incomplete.failed")&&n({error:s.context.errors.authentication||null,isError:!0,isSuccess:!1,needsOtp:!1})})}),Jr=(t,e,r)=>new Promise(n=>{const{changed:i}=t.send({type:"PASSWORDLESS_SMS_OTP",phoneNumber:e,otp:r});if(!i)return n({error:Z,isError:!0,isSuccess:!1,user:null,accessToken:null,refreshToken:null});t.onTransition(s=>{s.matches({authentication:"signedIn"})?n({error:null,isError:!1,isSuccess:!0,user:s.context.user,accessToken:s.context.accessToken.value,refreshToken:s.context.refreshToken.value}):s.matches({registration:{incomplete:"failed"}})&&n({error:s.context.errors.authentication||null,isError:!0,isSuccess:!1,user:null,accessToken:null,refreshToken:null})})}),Zr=async(t,e)=>new Promise(r=>{const{event:n}=t.send("SIGNOUT",{all:e});if(n.type!=="SIGNED_OUT")return r({isSuccess:!1,isError:!0,error:Yt});t.onTransition(i=>{i.matches({authentication:{signedOut:"success"}})?r({isSuccess:!0,isError:!1,error:null}):i.matches("authentication.signedOut.failed")&&r({isSuccess:!1,isError:!0,error:i.context.errors.signout||null})})}),Vt=(t,e,r,n,i)=>new Promise(s=>{const{changed:o,context:l}=t.send("SIGNUP_EMAIL_PASSWORD",{email:e,password:r,options:n,requestOptions:i});if(!o)return s({error:Z,accessToken:l.accessToken.value,refreshToken:l.refreshToken.value,isError:!0,isSuccess:!1,needsEmailVerification:!1,user:l.user});t.onTransition(u=>{u.matches("registration.incomplete.failed")?s({accessToken:null,refreshToken:null,error:u.context.errors.registration||null,isError:!0,isSuccess:!1,needsEmailVerification:!1,user:null}):u.matches({authentication:{signedOut:"noErrors"},registration:{incomplete:"needsEmailVerification"}})?s({accessToken:null,refreshToken:null,error:null,isError:!1,isSuccess:!1,needsEmailVerification:!0,user:null}):u.matches({authentication:"signedIn",registration:"complete"})&&s({accessToken:u.context.accessToken.value,refreshToken:u.context.refreshToken.value,error:null,isError:!1,isSuccess:!0,needsEmailVerification:!1,user:u.context.user})})}),en=(t,e,r,n)=>new Promise(i=>{const{changed:s,context:o}=t.send("SIGNUP_SECURITY_KEY",{email:e,options:r,requestOptions:n});if(!s)return i({error:Z,accessToken:o.accessToken.value,refreshToken:o.refreshToken.value,isError:!0,isSuccess:!1,needsEmailVerification:!1,user:o.user});t.onTransition(l=>{l.matches("registration.incomplete.failed")?i({accessToken:null,refreshToken:null,error:l.context.errors.registration||null,isError:!0,isSuccess:!1,needsEmailVerification:!1,user:null}):l.matches({authentication:{signedOut:"noErrors"},registration:{incomplete:"needsEmailVerification"}})?i({accessToken:null,refreshToken:null,error:null,isError:!1,isSuccess:!1,needsEmailVerification:!0,user:null}):l.matches({authentication:"signedIn",registration:"complete"})&&i({accessToken:l.context.accessToken.value,refreshToken:l.context.refreshToken.value,error:null,isError:!1,isSuccess:!0,needsEmailVerification:!1,user:l.context.user})})}),tn=(t,e,r)=>new Promise(n=>{const{changed:i}=t.send("SIGNIN_EMAIL_OTP",{email:e,options:r});if(!i)return n({error:Z,isError:!0,isSuccess:!1,needsOtp:!1});t.onTransition(s=>{s.matches("registration.incomplete.needsOtp")?n({error:null,isError:!1,isSuccess:!0,needsOtp:!0}):s.matches("registration.incomplete.failed")&&n({error:s.context.errors.authentication||null,isError:!0,isSuccess:!1,needsOtp:!1})})}),rn=(t,e,r)=>new Promise(n=>{const{changed:i}=t.send({type:"VERIFY_EMAIL_OTP",email:e,otp:r});if(!i)return n({error:Z,isError:!0,isSuccess:!1,user:null,accessToken:null,refreshToken:null});t.onTransition(s=>{s.matches({authentication:"signedIn"})?n({error:null,isError:!1,isSuccess:!0,user:s.context.user,accessToken:s.context.accessToken.value,refreshToken:s.context.refreshToken.value}):s.matches({registration:{incomplete:"failed"}})&&n({error:s.context.errors.authentication||null,isError:!0,isSuccess:!1,user:null,accessToken:null,refreshToken:null})})}),nn=(t,{provider:e,idToken:r,nonce:n})=>new Promise(i=>{const{changed:s}=t.send("SIGNIN_ID_TOKEN",{provider:e,idToken:r,...n&&{nonce:n}});s||i({isSuccess:!1,isError:!0,error:Z,user:null,accessToken:null,refreshToken:null}),t.onTransition(o=>{if(o.matches({authentication:{signedOut:"failed"}}))return i({accessToken:null,refreshToken:null,user:null,error:o.context.errors.authentication||null,isError:!0,isSuccess:!1});if(o.matches({authentication:"signedIn"}))return i({accessToken:o.context.accessToken.value,refreshToken:o.context.refreshToken.value,user:o.context.user,error:null,isError:!1,isSuccess:!0})})}),sn=async({backendUrl:t,interpreter:e},{provider:r,idToken:n,nonce:i})=>{try{return await te(`${t}/link/idtoken`,{provider:r,idToken:n,...i&&{nonce:i}},e==null?void 0:e.getSnapshot().context.accessToken.value),{isError:!1,error:null,isSuccess:!0}}catch(s){const{error:o}=s;return{isError:!0,error:o,isSuccess:!1}}},on=t=>new Promise(e=>{const{changed:r,context:n}=t.send({type:"SIGNIN_SECURITY_KEY"});if(!r)return e({accessToken:n.accessToken.value,refreshToken:n.refreshToken.value,error:Z,isError:!0,isSuccess:!1,needsEmailVerification:!1,user:n.user});t.onTransition(i=>{i.matches({authentication:{signedOut:"noErrors"},registration:{incomplete:"needsEmailVerification"}})?e({accessToken:null,refreshToken:null,error:null,isError:!1,isSuccess:!1,needsEmailVerification:!0,user:null}):i.matches({authentication:{signedOut:"failed"}})?e({accessToken:null,refreshToken:null,error:i.context.errors.authentication||null,isError:!0,isSuccess:!1,needsEmailVerification:!1,user:null}):i.matches({authentication:"signedIn"})&&e({accessToken:i.context.accessToken.value,refreshToken:i.context.refreshToken.value,error:null,isError:!1,isSuccess:!0,needsEmailVerification:!1,user:i.context.user})})}),Ri=async({backendUrl:t,interpreter:e},{expiresAt:r,metadata:n})=>{try{const{data:i}=await te(`${t}/pat`,{expiresAt:r.toISOString(),metadata:n},e==null?void 0:e.getSnapshot().context.accessToken.value);return{data:i?{id:i.id||null,personalAccessToken:i.personalAccessToken||null}:null,isError:!1,error:null,isSuccess:!0}}catch(i){const{error:s}=i;return{isError:!0,error:s,isSuccess:!1,data:null}}};class Ai{constructor({url:e,broadcastKey:r,autoRefreshToken:n=!0,autoSignIn:i=!0,clientStorage:s,clientStorageType:o,refreshIntervalTime:l,start:u=!0}){var f;this.url=e,this._client=new Lt({backendUrl:e,clientUrl:typeof window!="undefined"&&((f=window.location)==null?void 0:f.origin)||"",broadcastKey:r,autoRefreshToken:n,autoSignIn:i,start:u,clientStorage:s,clientStorageType:o,refreshIntervalTime:l})}async signUp(e,r){const n=await this.waitUntilReady();if("securityKey"in e){const{email:l,options:u}=e;return ie(await en(n,l,u,r))}const{email:i,password:s,options:o}=e;return ie(await Vt(n,i,s,o,r))}async connectProvider(e){const n=(await this.waitUntilReady()).getSnapshot().context.accessToken.value,{provider:i,options:s}=e,o=ut(`${this._client.backendUrl}/signin/provider/${i}`,re(this._client.clientUrl,{...s,connect:n}));return Be()&&(window.location.href=o),{providerUrl:o}}async signInIdToken(e){const r=await this.waitUntilReady(),n=await nn(r,e);return{...ie(n),mfa:null}}async linkIdToken(e){return sn(this._client,e)}async signIn(e){const r=await this.waitUntilReady();if(!e){const n=await $r(r);return{...ie(n),mfa:null}}if("provider"in e){const{provider:n,options:i}=e,s=ut(`${this._client.backendUrl}/signin/provider/${n}`,re(this._client.clientUrl,i));return Be()&&(window.location.href=s),{providerUrl:s,provider:n,session:null,mfa:null,error:null}}if("email"in e&&"password"in e){const n=await Wr(r,e.email,e.password);return n.needsEmailVerification?{session:null,mfa:null,error:qt}:n.needsMfaOtp?{session:null,mfa:n.mfa,error:null}:{...ie(n),mfa:null}}if("email"in e&&"securityKey"in e){if(e.securityKey!==!0)throw Error("securityKey must be true");const n=await Yr(r,e.email);return{...ie(n),mfa:null}}if("email"in e){const{email:n,options:i}=e,{error:s}=await jt(r,n,i);return{session:null,mfa:null,error:s}}if("phoneNumber"in e&&"otp"in e){const n=await Jr(r,e.phoneNumber,e.otp);return{...ie(n),mfa:null}}if("phoneNumber"in e){const{error:n}=await Kt(r,e.phoneNumber,e.options);return{error:n,mfa:null,session:null}}if("otp"in e){const n=await Xr(r,e.otp,e.ticket);return{...ie(n),mfa:null}}return{error:Xt,mfa:null,session:null}}async signInPAT(e){const r=await this.waitUntilReady(),n=await Qr(r,e);return ie(n)}async signInEmailOTP(e,r){const n=await this.waitUntilReady(),{error:i}=await tn(n,e,r);return{error:i,session:null,mfa:null}}async verifyEmailOTP(e,r){const n=await this.waitUntilReady(),i=await rn(n,e,r);return{...ie(i),mfa:null}}async signInSecurityKey(){const e=await this.waitUntilReady(),r=await on(e);return{...ie(r),mfa:null}}async signOut(e){const r=await this.waitUntilReady(),{error:n}=await Zr(r,e==null?void 0:e.all);return{error:n}}async resetPassword({email:e,options:r}){const n=Re(Lr(this._client)).start(),{error:i}=await Fr(n,e,r);return{error:i}}async changePassword({newPassword:e,ticket:r}){const n=Re(Mr(this._client)).start(),{error:i}=await Br(n,e,r);return{error:i}}async sendVerificationEmail({email:e,options:r}){const n=Re(jr(this._client)).start(),{error:i}=await Hr(n,e,r);return{error:i}}async changeEmail({newEmail:e,options:r}){const n=Re(Ur(this._client)).start(),{error:i}=await Gr(n,e,r);return{error:i}}async deanonymize(e){const r=await this.waitUntilReady();if(e.signInMethod==="passwordless"){if(e.connection==="email"){const{error:n}=await jt(r,e.email,e.options);return{error:n}}if(e.connection==="sms"){const{error:n}=await Kt(r,e.phoneNumber,e.options);return{error:n}}}if(e.signInMethod==="email-password"){const{error:n}=await Vt(r,e.email,e.password,e.options);return{error:n}}throw Error("Unknown deanonymization method")}async addSecurityKey(e){const{error:r,key:n}=await Vr(this._client,e);return{error:r,key:n}}async elevateEmailSecurityKey(e){if(!e)throw Error("A user email is required");return{...await zr(this._client,e),mfa:null}}async createPAT(e,r){return Ri(this._client,{expiresAt:e,metadata:r})}onTokenChanged(e){return this._client.subscribe(()=>{var n;const r=(n=this._client.interpreter)==null?void 0:n.onTransition(({event:i,context:s})=>{i.type==="TOKEN_CHANGED"&&e(Ge(s))});return()=>r==null?void 0:r.stop()})}onAuthStateChanged(e){return this._client.subscribe(()=>{var n;const r=(n=this._client.interpreter)==null?void 0:n.onTransition(({event:i,context:s})=>{(i.type==="SIGNED_IN"||i.type==="SIGNED_OUT")&&e(i.type,Ge(s))});return()=>r==null?void 0:r.stop()})}isAuthenticated(){var e;return!!((e=this._client.interpreter)!=null&&e.getSnapshot().matches({authentication:"signedIn"}))}async isAuthenticatedAsync(){return(await this.waitUntilReady()).getSnapshot().matches({authentication:"signedIn"})}getAuthenticationStatus(){var r;const e=((r=this.client.interpreter)==null?void 0:r.getSnapshot().context.importTokenAttempts)||0;return this.isReady()?{isAuthenticated:this.isAuthenticated(),isLoading:!1,connectionAttempts:e}:{isAuthenticated:!1,isLoading:!0,connectionAttempts:e}}getAccessToken(){var e,r;return(r=(e=this._client.interpreter)==null?void 0:e.getSnapshot().context.accessToken.value)!=null?r:void 0}getDecodedAccessToken(){const e=this.getAccessToken();return e?ln(e):null}getHasuraClaims(){var e;return((e=this.getDecodedAccessToken())==null?void 0:e["https://hasura.io/jwt/claims"])||null}getHasuraClaim(e){var r;return((r=this.getHasuraClaims())==null?void 0:r[e.startsWith("x-hasura-")?e:`x-hasura-${e}`])||null}async refreshSession(e){try{const r=await this.waitUntilReady();return new Promise(n=>{const i=e||r.getSnapshot().context.refreshToken.value;if(!i)return n({session:null,error:$t});const{changed:s}=r.send("TRY_TOKEN",{token:i});if(!s)return n({session:null,error:Wt});r.onTransition(o=>{o.matches({token:{idle:"error"}})?n({session:null,error:zt}):o.event.type==="TOKEN_CHANGED"&&n({session:Ge(o.context),error:null})})})}catch(r){return{session:null,error:r.message}}}getSession(){var e,r;return Ge((r=(e=this._client.interpreter)==null?void 0:e.getSnapshot())==null?void 0:r.context)}async initWithSession({session:e}){this.client.start({initialSession:e}),await this.waitUntilReady()}getUser(){var e,r,n;return((n=(r=(e=this._client.interpreter)==null?void 0:e.getSnapshot())==null?void 0:r.context)==null?void 0:n.user)||null}waitUntilReady(){const r=this._client.interpreter;if(!r)throw Error("Auth interpreter not set");return r.getSnapshot().hasTag("loading")?new Promise((n,i)=>{let s=setTimeout(()=>i("The state machine is not yet ready after 15 seconds."),15e3);r.onTransition(o=>{if(!o.hasTag("loading"))return clearTimeout(s),n(r)})}):Promise.resolve(r)}isReady(){var e,r;return!((r=(e=this._client.interpreter)==null?void 0:e.getSnapshot())!=null&&r.hasTag("loading"))}get client(){return this._client}}T.AuthClient=Lt,T.AuthClientSSR=Ei,T.AuthCookieClient=Kr,T.CodifiedError=ve,T.EMAIL_NEEDS_VERIFICATION=qt,T.HasuraAuthClient=Ai,T.INITIAL_MACHINE_CONTEXT=st,T.INVALID_EMAIL_ERROR=se,T.INVALID_MFA_CODE_ERROR=Bt,T.INVALID_MFA_TICKET_ERROR=Ft,T.INVALID_MFA_TYPE_ERROR=Gt,T.INVALID_PASSWORD_ERROR=He,T.INVALID_PHONE_NUMBER_ERROR=dt,T.INVALID_REFRESH_TOKEN=zt,T.INVALID_SIGN_IN_METHOD=Xt,T.MIN_PASSWORD_LENGTH=3,T.NETWORK_ERROR_CODE=0,T.NHOST_JWT_EXPIRES_AT_KEY=he,T.NHOST_REFRESH_TOKEN_ID_KEY=ke,T.NHOST_REFRESH_TOKEN_KEY=ce,T.NO_MFA_TICKET_ERROR=Ht,T.NO_REFRESH_TOKEN=$t,T.OTHER_ERROR_CODE=1,T.REFRESH_TOKEN_MAX_ATTEMPTS=5,T.STATE_ERROR_CODE=20,T.TOKEN_REFRESHER_RUNNING_ERROR=Wt,T.TOKEN_REFRESH_MARGIN_SECONDS=60,T.USER_ALREADY_SIGNED_IN=Z,T.USER_NOT_ANONYMOUS=an,T.USER_UNAUTHENTICATED=Yt,T.VALIDATION_ERROR_CODE=10,T.activateMfaPromise=wi,T.addSecurityKeyPromise=Vr,T.changeEmailPromise=Gr,T.changePasswordPromise=Br,T.createAuthMachine=Cr,T.createChangeEmailMachine=Ur,T.createChangePasswordMachine=Mr,T.createEnableMfaMachine=gi,T.createResetPasswordMachine=Lr,T.createSendVerificationEmailMachine=jr,T.disableMfaPromise=Si,T.elevateEmailSecurityKeyPromise=zr,T.encodeQueryParameters=ut,T.generateQrCodePromise=Ti,T.getAuthenticationResult=ie,T.getFetch=xr,T.getParameterByName=Fe,T.getSession=Ge,T.isBrowser=Be,T.isValidEmail=ae,T.isValidPassword=lt,T.isValidPhoneNumber=Mt,T.isValidTicket=Dr,T.linkIdTokenPromise=sn,T.localStorageGetter=Ir,T.localStorageSetter=kr,T.postFetch=te,T.removeParameterFromWindow=Ut,T.resetPasswordPromise=Fr,T.rewriteRedirectTo=re,T.sendVerificationEmailPromise=Hr,T.signInAnonymousPromise=$r,T.signInEmailOTPPromise=tn,T.signInEmailPasswordPromise=Wr,T.signInEmailPasswordlessPromise=jt,T.signInEmailSecurityKeyPromise=Yr,T.signInIdTokenPromise=nn,T.signInMfaTotpPromise=Xr,T.signInPATPromise=Qr,T.signInSecurityKeyPromise=on,T.signInSmsPasswordlessOtpPromise=Jr,T.signInSmsPasswordlessPromise=Kt,T.signOutPromise=Zr,T.signUpEmailPasswordPromise=Vt,T.signUpEmailSecurityKeyPromise=en,T.verifyEmailOTPPromise=rn,Object.defineProperty(T,Symbol.toStringTag,{value:"Module"})});
//# sourceMappingURL=hasura-auth-js.umd.js.map
